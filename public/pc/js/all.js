function googleAnalytics(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//www.google-analytics.com/ga.js",document.getElementsByTagName("head")[0].appendChild(e)}function synchronizeTime(){$("time.relative-time").each(function(){this.innerHTML=new Date($(this).attr("datetime").replace(/\-/g,"/")).elapsedTime()})}function ctrlenterkey(e,t){t=$.event.fix(t),(t.ctrlKey&&13==t.which||10==t.which)&&$(e).trigger("submit"),$.inArray(t.which,[37,38,39,40])>=0&&t.stopPropagation()}function buildQuery(e){var t=[];for(var i in e)void 0!=e[i]&&t.push(i+"="+encodeURIComponent(e[i]));return t.join("&")}function scrollTo(e){$("html, body").animate({scrollTop:$(e).offset().top},200,"swing")}function scrollToBottom(e){var t=e.offset().top+e.height()-$window.height();t>$window.scrollTop()&&$("html, body").animate({scrollTop:t},200,"swing")}function handleResponse(e,t){try{var i=$.parseJSON(e);null!==i?t(i,e):alert(e)}catch(a){alert(e)}}function $ProgressTag(e){return e.addEvents({onRequest:ProgressTag.showTag,onCancel:ProgressTag.hideTag,onComplete:ProgressTag.hideTag}),e}function openInDialog(e){var t=new Dialog;return t.el.load(this.href,null,t.attach.bind(t)),t.open(),!1}function openDialog(e,t){return"object"==typeof dialog&&dialog.el.remove(),dialog=new Dialog(twig({ref:"dialogs/"+e}).render(t||{}).toString()).open(),dialog}function navInit(){$(".navbar-secondary").click(function(e){var t=$(e.target);(t.hasClass("navbar-secondary")||t.hasClass("navbar-subnav"))&&$("html, body").animate({scrollTop:0},300,"swing")});var e=$(".navbar-secondary"),t=$("body").hasClass("has-subnav");$(window).scroll(function(){if($("body").height()<window.innerHeight+120)return!1;var i=$window.scrollTop()>=60;e[i?"addClass":"removeClass"]("navbar-fixed-top"),i&&t?$(".pc-header").css("margin-bottom",e.height()):$(".pc-header").css("margin-bottom",0)});var i=$(".nav-search .search-dropdown-menu");$(".nav-search .search-input").on("focus",function(e){i.addClass("active-dropdown-menu")}).on("blur",function(){setTimeout(function(){i.removeClass("active-dropdown-menu")},300)}),i.on("click","a",function(e){location.href=$(e.target).data("href")+"?query="+$(".search-input").val()}),$(".nav-left a, .nav-right a").on("click",function(e){var t=$(this).data("target");$(".subnav-narrow").children().not("."+t).hide(),$("."+t).toggle()})}function checkLogin(){return 0!=visitor.id?!0:(dialog=popLogin(),!1)}function handleLazyLoad(e){$(".feed-list").hasClass("lazyload")&&$.each(e.toArray(),function(){var e=$(this);e.hasClass("loaded")||($.each(e.find("img.normal"),function(){var e=$(this);e.attr("src",e.attr("_src"))}),e.addClass("loaded"))})}function loadActivity(e,t){var i={offset:e.data("offset"),count:20};i.offset>0&&(i.mark_as_read=1),e.data("before-timestamp")&&(i.before_timestamp=e.data("before-timestamp")),e.data("loading",1),t||(e.data("offset",e.data("offset")+20),$(".activity-load-more").addClass("loading")),TuchongClient.get("users/self/activities",i,function(a){var o="",n=a.sites;e.data("loading",0),$(".activity-load-more").removeClass("loading"),t&&e.data("preloaded",1),e.data("before-timestamp",a.before_timestamp),$.each(a.activityList,function(t,i){function a(e){e.images.length>0?(e.isPhoto=!0,1===e.images.length||"text"==e.type?e.isSinglePhoto=!0:e.isMultiPhoto=!0):e.isText=!0}switch(i.site_id_array&&(i.sites=[],$.each(i.site_id_array,function(){i.sites.push(n[this])})),i.type){case"like-comment":i.note.author_id&&(i.note.author=n[i.note.author_id]),i.note.reply_to_array&&(i.note.reply_to=[],$.each(i.note.reply_to_array,function(){i.note.reply_to.push(n[this])})),o+=twig({ref:"activity-like-comment"}).render(i);break;case"like-site":o+=twig({ref:"activity-like-site"}).render(i);break;case"repost":case"like-post":case"post":i.post.site=n[i.post.site_id],i.post.author=n[i.post.author_id],i.post.original_post?(i.post.original_post.site=n[i.post.original_post.site_id],i.post.original_post.author=n[i.post.original_post.author_id],i.contentPost=i.post.original_post):i.contentPost=i.post,a(i.contentPost),i.container_width=e.width()-16,i.omit="like-post"==i.type?1:3,o+=twig({ref:"activity-post"}).render(i)}});var s=$(o);i.offset==e.data("offset")&&s.addClass("hide"),s.appendTo(e);var r=e.data("activityAnalyze");r.add(s),r.analyze()})}function initActivity(e,t){var i=$(e),a=new ViewAnalytics;a.listenWindowScroll(),i.data("activityAnalyze",a),loadActivity(i),$window.scroll(function(){if(1!=i.data("loading")&&1!=i.data("preloaded")){var e=i.offset().top+i.height(),t=$(document).scrollTop()+$window.height();800>e-t&&loadActivity(i,i.data("offset")%60==0&&i.data("offset")>0)}}),$(".activity-load-more .load-more").click(function(){1==i.data("preloaded")?(i.data("preloaded",0),i.find("li.hide").removeClass("hide"),i.data("offset",i.data("offset")+20)):1==i.data("loading")?($(".activity-load-more").addClass("loading"),i.data("offset",i.data("offset")+20)):loadActivity(i,!1)})}function commentsInit(e){e.find(".prev-comment-page").click(function(){var t={note_id:e.data("beginNoteId"),direction:"prev"};"site"==e.data("comments")&&(t.site_id=e.data("siteId")),void 0!=e.data("type")&&(t.type=e.data("type")),TuchongClient.get("posts/"+e.data("postId")+"/comments",t,local.showComment(e,"prev",twig({ref:"full-comment"})))}),e.find(".next-comment-page").click(function(){var t={note_id:e.data("endNoteId"),direction:"next"};"site"==e.data("comments")&&(t.site_id=e.data("siteId")),void 0!=e.data("type")&&(t.type=e.data("type")),TuchongClient.get("posts/"+e.data("postId")+"/comments",t,local.showComment(e,"next",twig({ref:"full-comment"})))}),e.find(".site-comments").click(function(){e.data("comments","site");var t={site_id:e.data("siteId")};TuchongClient.get("posts/"+e.data("postId")+"/comments",t,local.showComment(e,"first",twig({ref:"full-comment"})))}),e.find(".all-comments").click(function(){e.data("comments","all"),e.data("type","comment");var t={type:"comment"};TuchongClient.get("posts/"+e.data("postId")+"/comments",t,local.showComment(e,"first",twig({ref:"full-comment"})))}),e.find(".all-reposts").click(function(){e.data("type","repost");var t={type:"repost"};TuchongClient.get("posts/"+e.data("postId")+"/comments",t,local.showComment(e,"first",twig({ref:"full-comment"})))});var t={type:"comment"};TuchongClient.get("posts/"+e.data("postId")+"/comments",t,local.showComment(e,"first",twig({ref:"full-comment"})))}function toggleReplybox(e){var t=$(this).closest("li.post"),i=t.find(".comments");return i.length&&i.hasClass("expanded")?i.removeClass("expanded"):showReplybox(t,!1),!1}function showReplybox(e,t){var i=e.data("postId"),a=e.data("siteId"),o=e.next(".inline-comments");0==o.length&&(o=$('<div class="comments-wrapper inline-comments"><ol class="comment-list-inline"></ol> <div class="comments-paginator"><a class="prev-comment-page">较旧的评论</a><a class="next-comment-page">较新的评论</a></div>'+(visitor.id?twig({ref:"replybox"}).render({site_id:a,post_id:i,weiboAccount:weiboAccount}):"")+"</div>").insertAfter(e),o.delegate(".prev-comment-page","click",function(){var e={type:"comment",note_id:o.data("beginNoteId"),direction:"prev"};TuchongClient.get("posts/"+i+"/comments",e,local.showComment(o,"prev",twig({ref:"comment"})))}).delegate(".next-comment-page","click",function(){var e={type:"comment",note_id:o.data("endNoteId"),direction:"next"};TuchongClient.get("posts/"+i+"/comments",e,local.showComment(o,"next",twig({ref:"comment"})))})),o.addClass("expanded");var n=o.find("form");o.hasClass("loading")?t&&scrollToBottom(n):(o.addClass("loading"),TuchongClient.get("posts/"+i+"/comments",{type:"comment"},function(e,i){var a="";$.each(e.commentlist,function(e){a=twig({ref:"comment"}).render(this)+a}),o.removeClass("loading").addClass("expanded").find("ol").empty().html(a),t&&scrollToBottom(n);var s=e.commentlist.length;s&&(o.data("beginNoteId",e.commentlist[s-1].note_id),o.data("endNoteId",e.commentlist[0].note_id),e.no_more_comment||o.find("menu").addClass("has-prev"))})),t&&(n.show(),n[0].content.focus())}function replyboxFocusListener(e){$(e).closest(".comments").addClass("reply")}function replyboxResetListener(e){$(e).closest(".comments").removeClass("reply")}function changeImage(){this.find(".loaded").css("visibility","hidden").hide().appendTo(this).show(200)}function loadImage(e){var t=$(this).parent().addClass("loaded");switch(e.loaded){case void 0:t.inject(e),e.loaded=1;break;case 1:changeImage.periodical(5e3,$("#frontImageWrapper"));default:e.loaded++}}function popLogin(e){return openDialog("login",{registerUrl:$("#registerAnchor").attr("href")})}function membershipDialog(e,t){var i='<div id="membershipDialog" class="dialog"><form action="/api/membership/set/" method="post" onsubmit="$( this ).ajaxsubmit( local.showInDialog ); return false;"><h2>更改用户等级</h2><input type="hidden" name="user_id" value="'+e+'" /><input type="hidden" name="grp_id" value="'+t+'" /><div class="dialog-body"></div><div class="dialog-footer"><button type="reset" onclick="dialog.close()" class="btn btn-sm">取消</button><button type="submit" class="btn btn-sm btn-primary">确定</button></div></form></div>';dialog=new Dialog(i).open(),Tuchong.get("membership/get/",{grp_id:t,user_id:e},function(e){var t=e.membership.membership,i="<label><input "+("5"==t?'checked="checked" ':"")+'type="radio" name="operation" value="administrator" />管理员</label><label><input '+("4"==t?'checked="checked" ':"")+'type="radio" name="operation" value="editor" />编辑</label><label><input '+("3"==t?'checked="checked" ':"")+'type="radio" name="operation" value="author" />作者</label><label><input '+("1"==t?'checked="checked" ':"")+'type="radio" name="operation" value="follower" />关注者</label><label><input '+("0"==t?'checked="checked" ':"")+'type="radio" name="operation" value="kick" />开除</label>';dialog.el.find(".dialog-body").addClass("loaded").html(i)})}function repostDialog(e,t){return 0==visitor.id?popLogin(e):(dialog=openDialog("repost",{weiboAccount:weiboAccount,post_id:t||$(this).closest("[data-post-id]").data("postId")}),Tuchong.get("site/mine/",{},function(e,t){var i=dialog.el.find(".repost-to-site ul");dialog.el.find(".repost-to-site").show(),i.addClass("loaded"),$.each(e.siteList,function(){$('<li><label class="radio-inline"><input type="radio" name="group_id[]" value="'+this.site_id+'" /><img src="'+this.icon+'" width="20" height="20" />'+this.name+"</label></li>").appendTo(i)})}),setTimeout(function(){dialog.el.find("[autofocus]").focus()},300),dialog)}function shareDialog(e,t){if(0==visitor.id)return popLogin(e);var i='<div class="dialog" style="width:300px;"> <h2>转发到小组</h2> <div class="dialog-body">  <ul class="share-site-list"></ul>	<p style="text-align:center;"><a href="'+web_root+'groups/new/">申请创建小组</a></p> </div></div>';return"object"==typeof dialog&&dialog.el.remove(),dialog=new Dialog(i).open(),t||(t=$(this).closest("[data-post-id]").data("postId")),TuchongClient.get("posts/"+t+"/groups",{referer:$.getReferer(),position:$.getLocation()},function(e,i){var a=dialog.el.find("ul");$.each(e.groupList,function(e,t){$('<li class="'+(t.exists?"is-favorite":"")+'"><a href="javascript:void(0);" data-site-id="'+t.site_id+'"><span class="icon-like"></span><img src="'+t.icon+'" width="20" height="20" /> '+t.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")+"</a></li>").appendTo(a)}),a.addClass("loaded").delegate("a","click",function(){var e=$(this).parent();return e.hasClass("is-favorite")?!1:(TuchongClient.post("groups/"+$(this).data("siteId")+"/posts/"+t,{nonce:nonce,referer:$.getReferer(),position:$.getLocation()},local.showInDialog),e.toggleClass("is-favorite"),!1)})}),dialog}function collectDialog(e,t){if(0==visitor.id)return popLogin(e);var i='<div class="dialog" style="width:300px;"> <h2>添加到收藏夹</h2> <div class="dialog-body">  <ul class="share-site-list"></ul>	<p style="text-align:center;"><a href="'+web_root+'collections/new/">新建收藏夹</a></p> </div></div>';return"object"==typeof dialog&&dialog.el.remove(),dialog=new Dialog(i).open(),t||(t=$(this).closest("[data-post-id]").data("postId")),TuchongClient.get("posts/"+t+"/collections-status",{referer:$.getReferer(),position:$.getLocation()},function(e,i){var a=dialog.el.find("ul");$.each(e.collectionList,function(e,t){$('<li class="'+(t.exists?"is-favorite":"")+'"><a href="javascript:void(0);" data-site-id="'+t.site_id+'"><span class="icon-like"></span><img src="'+t.icon+'" width="20" height="20" /> '+t.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")+"</a></li>").appendTo(a)}),a.addClass("loaded").delegate("a","click",function(){var e=$(this).parent();return e.hasClass("is-favorite")?!1:(TuchongClient.put("collections/"+$(this).data("siteId")+"/posts/"+t,{nonce:nonce,referer:$.getReferer(),position:$.getLocation()},local.showInDialog),e.toggleClass("is-favorite"),!1)})}),dialog}function popCreateAlbum(e){return dialog=openDialog("create-album"),dialog.el.find("form").submit(function(e){return $(this).ajaxsubmit(function(e,t){Model.myAlbums.add(e.album),dialog.close()}),!1}),dialog}function addToAlbumDialog(e){return dialog=openDialog("add-to-album",{img_id:e}),Tuchong.get("album/get-list",{img_id:e},function(e,t){switch(e.result){case"SUCCESS":var i="<ul>"+$.map(e.albums,function(e){return'<li data-album-id="'+e.id+'"><img src="'+e.cover+'" /><em>'+e.title+'</em><input type="checkbox" name="alb_id[]" value="'+e.id+'" /></li>'}).join("")+"</ul>";dialog.setBody(i),dialog.place(),$("#albumSelector ul li").click(function(){$(this).toggleClass("selected"),$(this).find("input").attr("checked",$(this).hasClass("selected"))});break;default:alert(e.message)}}),dialog}function addToSiteDialog(e){return code='<div class="dialog" style="width:400px;"> <h2>添加到小站和小组</h2> <div class="dialog-body" style="padding:20px 40px;">  <p class="center">正在载入</p> </div></div>',"object"==typeof dialog&&dialog.el.remove(),dialog=new Dialog(code).open(),Tuchong.get("membership/get-from-mine/",{user_id:e},function(t){switch(t.result){case"SUCCESS":dialog.setBody(twig({ref:"site-selector-items"}).render({siteList:t.siteList,user_id:e}).toString()),dialog.place();var i=dialog.el.find("ul");i.delegate("a","click",function(){var t={site_id:$(this).data("siteId"),user_id:e,membership:3,referer:$.getReferer(),position:$.getLocation()};return Tuchong.post("membership/create/",t,local.dialogClose),!1});break;default:alert(t.message)}}),dialog}function toggleTagbox(e,t){var i=$("#tagBox");i.hasClass("expanded")?(i.removeClass("expanded"),$("#tagList").show(),e.innerHTML="添加标签"):(i.addClass("expanded"),$("#tagList").hide(),$("#imageTagSuggest").addClass("loading").html("正在加载"),$("#userTagSuggest").addClass("loading").html("正在加载"),Tuchong.post("tag/suggest/",{img_id:t},function(e,t){var a=i.find("input[name=tagstr]");a.value=e.userimagetags.join(" "),a.focus(),e.imagetags?$("#imageTagSuggest").empty().removeClass("loading").adopt(loadTag(e.imagetags,e.userimagetags)):$("#imageTagSuggest").html("还没有标签"),e.imagetags?$("#userTagSuggest").empty().removeClass("loading").adopt(loadTag(e.usertags,e.userimagetags)):$("#userTagSuggest").html("你还没有标签"),TagSuggest(a,$("#userTagSuggest a").extend($("#imageTagSuggest a")))}),e.innerHTML="关闭")}function loadTag(e,t){return e.map(function(e){var i=$("<a></a>").text(e);return t.contains(e)&&i.addClass("checked"),$("<li></li>").append(i)})}function TagSuggest(e,t){$.each(t,function(i){i.click(function(){t.each(function(e){e.innerHTML==i.innerHTML&&e.toggleClass("checked")});var a=e.value.split(" ");a.contains(this.innerHTML)?a.erase(this.innerHTML):a.push(this.innerHTML),e.value=a.join(" "),e.focus()}.bind(i))}),$(e).change(function(){$.each(this,function(e){this.contains(e.innerHTML)?e.addClass("checked"):e.removeClass("checked")},e.value.split(" "))}.bind(t))}function SelectMonth(e,t,i,a,o){for(y=a,m=o;y>t||m>=i;m--)0==m&&(y--,m=12),e.options.add(new Option(y+"年"+m+"月",y+"/"+m+"/"))}function handleRequest(){}function tagEditorInit(e){$(".tag-editor").bind("click",function(){$(this).find(".text").focus()}).delegate("a.del","click",function(){var e=$(this).parent();e.closest(".tag-list").length&&e.find("a.tag").length?e.addClass("hide"):e.remove()}).delegate(".text","keydown",function(t){if($.inArray(t.keyCode,[13,10,32,59,188])>-1){if(t.stopPropagation(),13==t.keyCode&&t.ctrlKey)return $(this).closest("form").submit(),!1;if(e&&$(".tag-editor span").length==e)return this.value="",!1;var i=$(this);return $.each(this.value.split(/[ 　]/),function(e,t){""!=t&&$("<span><input type='hidden' name='tags[]' value='"+t+"' /><em class='tag'>"+t+"</em><a class='del'>x</a></span>").insertBefore(i)}),this.value="",this.focus(),!1}if(8==t.keyCode&&(t.stopPropagation(),""==this.value))for(var a=$(this).prev();;){if(0==a.length||!a.is("span"))break;if(!a.closest(".tag-list").length){a.remove();break}if(a.find("a.tag").length&&!a.hasClass("hide")){a.addClass("hide");break}if(a.find("em").length){a.remove();break}a=a.prev()}}),$(".tag-editor .text").change(function(){var e=$(this);$.each(this.value.split(/[ 　]/),function(t,i){""!=i&&$("<span><input type='hidden' name='tags[]' value='"+i+"' /><em class='tag'>"+i+"</em><a class='del'>x</a></span>").insertBefore(e)}),this.value=""}),$(".tag-selector").delegate("a.tag-btn","click",function(){if(!e||$(".tag-editor span").length!=e){var t=$(this).text();$("<span><input type='hidden' name='tags[]' value='"+t+"' /><em class='tag'>"+t+"</em><a class='del'>x</a></span>").insertBefore($(".tag-editor .text"))}})}function editableInit(){$(".editable").click(inlineEdit),$(".editable").each(function(){var e=$(this);""==e.text()&&("title"==e.data("name")?e.html("<em>单击此处修改标题</em>"):e.html("<em>单击此处修改描述</em>"))})}function inlineEdit(){var e,t=$(this),i=t.data("id"),a=t.data("name"),o=t.find("em").length?"":t.text(),n=TuchongClient.restAPI+t.data("type")+"/"+i;switch(t.data("type")){case"album":e="alb_id";break;case"image":e="img_id";break;case"post":default:e="post_id"}var s='<form class="edit-form" method="patch" action="'+n+'"><input type="hidden" name="nonce" value="'+nonce+'" /><input type="hidden" name="'+e+'" value="'+i+'" /><textarea name="'+a+'">'+o+'</textarea><button class="btn btn-sm btn-primary" type="submit">确定</button><button type="reset" class="btn btn-sm btn-default">取消</button></form>';t.after(s);var r=t.next();r.bind({submit:function(e){return e.stopPropagation(),t.addClass("loading").show(),r.ajaxsubmit(function(e,i){"SUCCESS"==e.result&&t.html(r.find("textarea").attr("value").nl2br()),t.removeClass("loading")},function(e,i){local.alert(e,i),t.removeClass("loading")}),r.remove(),!1},reset:function(e){t.show(),r.remove()},keyup:function(e){27==e.keyCode&&r.trigger("reset"),13==e.keyCode&&e.ctrlKey&&r.trigger("submit")}}),r.css("width",t.outerWidth()),r.find("textarea").css({width:t.width(),height:t.height(),"font-size":t.css("font-size"),"line-height":t.css("line-height")}).focus(),t.hide()}function addToFavor(e,t,i){return window.sidebar?(window.sidebar.addPanel(t,i,""),!1):document.all?(window.external.AddFavorite(i,t),!1):window.opera&&window.print?(e.setAttribute("href",i),e.setAttribute("title",t),e.setAttribute("rel","sidebar"),e.click(),!1):window.chrome?(alert("请使用 ctrl+D 完成收藏 (对于苹果系统请使用 Command+D)"),!1):void 0}function spaceKey(e){var t=$(e.target);if(!(32!=e.which||e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||t.is("textarea")||t.is("input"))){var i=$(window).height(),a=$(document).scrollTop(),o=0,n=!1;if($("li.post").not(".more").each(function(e){return(o=$(this).offset().top)>a+4?(n=!(o-a>i),!1):void 0}),n)return $(document).scrollTop(o-3),!1}}function copyToClipboard(e){void 0==window.clipboardData?alert("您的浏览器不支持复制功能，请使用 Ctrl+C 或点击鼠标右键完成复制。"):window.clipboardData.setData("text",e)?alert("复制成功，现在您可以粘贴(Ctrl+v)到其他地方了。"):alert("您取消了复制，请使用 Ctrl+C 或点击鼠标右键完成复制。")}function quitSite(e){confirm("你确定要退出小组吗？")&&TuchongClient["delete"]("sites/"+e+"/members",{},local.operation)}function follow(e,t){checkLogin()&&TuchongClient.put("users/self/following/"+e,{referer:$.getReferer(),position:$.getLocation()},function(){$(t).closest(".site-actions").addClass("following")})}function unfollow(e,t){confirm("你确定要取消关注吗？")&&TuchongClient["delete"]("users/self/following"+e,{referer:$.getReferer(),position:$.getLocation()},function(){$(t).closest(".site-actions").removeClass("following")})}function getMessageList(e,t){TuchongClient.get("conversations/"+e+"/messages",{page:t},function(e){var i=twig({ref:"message"});$("#messageList").html($.map(e.response_messages,function(e){return i.render(e)}).join("")),getPageBar(e.count,e.pageSize,t,e.totalPage)})}function tagEditInit(e){e.delegate(".edit","click",function(){e.addClass("editing"),e.hasClass("init")||(tagEditorInit(0),e.addClass("init")),$(".tag-editor input").focus()}).delegate("button[type=reset]","click",function(){$.each($(".tag-editor span"),function(){var e=$(this);e.find("em").length?e.remove():e.removeClass("hide")}),e.removeClass("editing")}),e.find("form").submit(function(){var e=$(this);return e.find(".tag-editor span.hide").remove(),e.ajaxsubmit(local.operation),!1})}function countDown(e,t,i,a){var o=e,n=setInterval(function(){return o>=0?(i(o),void(o-=t)):(clearInterval(n),void a())},t)}function getCookie(e){for(var t,i,a,o=" "+e+"=",n=document.cookie.split(";"),s=0;s<n.length;s++)if(t=" "+n[s],i=t.indexOf(o),i>=0&&i+o.length==(a=t.indexOf("=")+1))return decodeURIComponent(t.substring(a,t.length).replace(/\+/g,""))}function setCookie(e,t,i,a,o,n){if("number"==typeof i){var s=i,r=i=new Date;r.setTime(+r+864e5*s)}document.cookie=[e,"=",escape(t),i?"; expires="+i.toUTCString():"",a?"; path="+a:"",o?"; domain="+options.domain:"",n?"; secure":""].join("")}function postRatio(e,t){var i=e/t;return.75>i?i=.75:i>4/3&&(i=4/3),i}function sortPostCollage(e){var t=20,i=400,a=e.width()-1,o=e.find(".post-collage"),n=o.length,s=[],r=0;o.each(function(e,o){var l=$(o),c=l.data("width")||200,d=l.data("height")||300;s.push(l);var p=s.length,u=postRatio(c,d);l.data("ratio",u),r+=u;var h=Math.round((a+t-p*t)/r);if(e+1==n)for(;h>i*(p+6)/10;)p++,h=Math.round((a+t-p*t)/(r*p/s.length));if(i*(p+6)/10>=h){var m=0;$.each(s,function(e,t){var i=$(t),a=i.data("ratio"),o=Math.round(a*h);m+=o,i.data("computeWidth",o)});var f=a-m*p/s.length,g=p-1;$.each(s,function(e,i){var a=$(i),o=a.data("computeWidth"),n={};if(n.width=o,n.marginBottom=t,0===e)n.clear="left",n.marginLeft=0;else{var s=Math.round(f/g);f-=s,--g,n.marginLeft=s,n.clear="none"}a.css(n),a.find(".main-collage>img, article").css({height:h,width:o})}),s=[],r=0}})}function initSortPostCollage(e){if(window.innerWidth>768){var t=$(window).height();e.css({minHeight:t}),sortPostCollage(e),e.data("init")||($(window).on("resize",function(){sortPostCollage(e)}),e.data("init",!0))}}function initBackToTop(e){$(window).scroll(function(t){var i=$(window).scrollTop();100>i?e.hide():e.show()}),e.on("click",function(e){$("html, body").animate({scrollTop:0},"slow","swing")})}function initTagActions(e){e.delegate(".tag-mark","click",function(t){var i=$(this),a=e.data("tagId");i.hasClass("tag-cancel-mark")?TuchongClient["delete"]("users/self/tagmarks/"+a,{referer:$.getReferer(),position:$.getLocation()},function(t){"SUCCESS"===t.result&&e.removeClass("marked")}):i.hasClass("tag-unmark")&&TuchongClient.put("users/self/tagmarks/"+a,{referer:$.getReferer(),position:$.getLocation()},function(t){"SUCCESS"===t.result&&e.addClass("marked")})})}function initTimeLine(e,t){e.find(".time-table-trigger").click(function(t){e.find(".time-table").slideToggle(100,"linear"),e.find(".time-table-trigger").toggleClass("active")}),$(document).click(function(t){t.target!==e.find(".time-table-trigger")[0]&&e.find(".time-table").is(":visible")&&(e.find(".time-table").slideUp(100,"linear"),e.find(".time-table-trigger").removeClass("active"))})}function RSAPublicKeyEncrypt(e){var t=new RSAKey;return t.setPublic(Tuchong.RSA_PUBLICK_KEY,"10001"),t.encrypt(e)}function genImageUrl(e,t){return"//photo.tuchong.com/"+e.user_id+"/"+t+"/"+e.img_id+Tuchong.imageFormat}function initUploadFile(e){new XMLHttpRequest;e.change(function(){function t(a,o){function n(){a[o+1]&&t(a,o+1)}var s=a[o],r=this,l=new FormData;for(var c in i)l.append(c,i[c]);l.append("photoupload",s);var d=new XMLHttpRequest,p={error:function(e){alert("连接不到服务器，请检查你的网络连接")},load:function(e){var t=e.target.status;if(t>=200&&300>t||304==t)uploadControllerFile.onUploadSuccess(this.responseText),r.value="",n();else{var i={413:"文件尺寸过大",500:"服务器内部错误，请通知管理员",502:"服务器网关错误，请通知管理员"};alert(i[t]||e.target.statusText)}}};for(var u in p)d.addEventListener(u,p[u],!1);d.open("POST",TuchongClient.restAPI+"images",!0),d.setRequestHeader("Cache-Control","no-cache"),d.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.send(l),e.addClass("uploading")}var i={user_id:visitor.id};$.each(this.files,function(){return this.type&&-1===$.inArray(this.type,["image/jpeg"])?void alert(this.name+"的格式是"+this.type+"，只支持上传JPG格式图片"):this.size>20971520?void alert(this.name+"的大小是"+formatUnit(this.size)+"，最大支持上传20MB图片"):void 0}),t(this.files,0),uploadControllerFile.checkMultiPhotos(),this.value=""})}function initEditorFileUpLoad(e,t){var i=window.navigator.userAgent,a=i.match(/Version\/.*Safari\//g);a?initUploadFile(e):(e.uploadify({swf:js_root+"uploadify.swf",uploader:web_root+"rest/images",cancelImage:style_root+"images/uploadify-cancel.png",auto:!0,multi:!0,checkExisting:!1,fileSizeLimit:"20MB",queueSizeLimit:30,fileObjName:"photoupload",postData:{user_id:visitor.id},buttonText:"img",buttonCursor:"pointer",fileTypeDesc:"JPEG格式",fileTypeExts:"*.jpg; *.jpeg; *.JPG; *.JPEG",removeTimeout:0,width:30,height:30,onUploadComplete:function(e,t){},onUploadError:function(e,t,i,a,o){alert(i)},onUploadSuccess:function(e,t,i){"string"==typeof t&&(t=JSON.parse(t));var a=t.image.source.l;"webp"===a.slice(-4)&&(a=a.slice(0,-4)+"jpg");var o='<p><img data-image-id="'+t.image.img_id+'" src="'+a+'" alt="'+t.image.title+'"></p><br>';$("#editor").append(o)}}),$("#editorImageInput").css({position:"absolute",top:0,left:0,opacity:0}))}function popSingleUpload(e){if(!/\.jpeg|\.jpg|\.png$/i.test(e.photoupload.value))return alert("请选择JPG类型的图片，尺寸至多20MB"),!1;var t='<div class="dialog" id="singleDialog"><div class="dialog-body"><div class="progressbar"></div><img class="progress-compat" src="'+style_root+'images/wait.gif" /><p class="progress-text">正在上传照片，请稍候</p></div></div>';return"object"==typeof dialog&&dialog.el.remove(),dialog=new Dialog(t).open(),$(e).fileSubmit({uploadProgress:local.progress(dialog.el.find(".progressbar"),dialog.el.find("p.progress-text")),error:function(e,t){dialog.el.find(".dialog").html('<h2>上传出错</h2><div class="dialog-body"><p class="progress-text">'+e.message+'</p></div><p class="dialog-footer"><button type="button" class="btn btn-sm btn-primary" onclick="dialog.close()">关闭</button></p>')},success:function(t,i){dialog.el.find(".dialog").html('<h2>上传成功，发布图博</h2><form action="/api/post/create/" method="post" onsubmit="$(this).ajaxsubmit(local.operation);return false;"><input type="hidden" name="type" value="photo" />'+(e.tag_id?'<input type="hidden" name="activity[]" value="'+e.tag_id.value+'" />':"")+'<input type="hidden" name="site_id" value="'+e.site_id.value+'" /><input type="hidden" name="img_id" value="'+t.image.img_id+'" /><input type="hidden" name="is_original" value="0" /><div class="dialog-body dialog-single-file"><div class="file-thumb" style="background-image:url('+t.image.source.s+')"></div><div class="file-data"><dl class="form"><dt>标题</dt><dd><input type="text" class="text file-title" name="title" value="'+(t.image.title||"")+'" /></dd><dt>描述</dt><dd><textarea class="file-description" name="content"></textarea></dd><dt>标签</dt><dd><input type="text" class="text file-tags" placeholder="标签之间用空格分隔" name="tags" /></dd><dt>相册</dt><dd><select name="alb_id"><option>选择添加到的相册</option></select></dd><dt></dt><dd><label><input class="checkbox" type="checkbox" name="is_original" value="1"'+(t.image.is_original?' checked="checked"':"")+' />这是我的原创作品</label></dd></dl></div></div><p class="dialog-footer"><button type="reset" onclick="Tuchong.post(\'post/delete/\', {post_id:'+t.image.post_id+'}, $.noop);dialog.close()" class="btn btn-sm">取消</button><button type="submit" class="btn btn-sm btn-primary">发布</button>'+(weiboAccount?'<label><input type="checkbox" name="postToWeibo" checked="checked" />同步到新浪微博</label>':"")+"</p></form>"),dialog.el.find("input[name=title]")[0].focus(),Tuchong.post("album/mine/",{},function(e,t){$.each(e.albumList,function(){dialog.el.find("select[name=alb_id]")[0].options.add(new Option(this.title,this.id))})})}}),dialog}function generalUpload(e,t){var i=$('<div class="progress"><div class="progressbar"></div><img class="progress-compat" src="'+style_root+'images/wait.gif" /><p class="progress-text"></p></div>').appendTo($(e));$(e).fileSubmit({uploadProgress:local.progress(i.find(".progressbar"),i.find(".progress-text")),error:local.alert,success:t||local.operation,complete:function(e){i.remove()}})}function isJpeg(e){if(!/\.(jpeg|jpg)$/i.test(e.value))return alert("请选择JPG/JPEG类型的图片"),!1;if(e.files){var t=e.files[0];if(t.type&&"image/jpeg"!==t.type.toLowerCase())return alert("请选择JPG/JPEG图片"),!1;if(e.form.MAX_FILE_SIZE&&t.size&&t.size>e.form.MAX_FILE_SIZE.value)return alert("文件尺寸不能大于"+formatUnit(e.form.MAX_FILE_SIZE.value)),!1}return!0}function isImage(e){if(!/\.(gif|jpeg|jpg|png)$/i.test(e.value))return alert("请选择JPG/PNG/GIF类型的图片"),!1;if(e.files){var t=e.files[0];if(t.type&&!/^image\/(gif|jpeg|png)$/i.test(t.type))return alert("请选择JPG/PNG/GIF类型的图片"),!1;if(e.form.MAX_FILE_SIZE&&t.size&&t.size>e.form.MAX_FILE_SIZE.value)return alert("文件尺寸不能大于"+formatUnit(e.form.MAX_FILE_SIZE.value)),!1}return!0}function toggleImgSelector(e){TuchongClient.get("users/"+visitor.id+"/albums",{},function(t){function i(e,t){switch(s.el.find(".selector-choice").empty(),e){case"all":Tuchong.get("photos/search/",{user_id:visitor.id,per_page:16,page:t},a);break;case"not_in_album":Tuchong.get("photos/search/",{user_id:visitor.id,alb_id:0,per_page:16,page:t},a);break;default:var i=e.split("-"),o=i[0],n=i[1];"album"==o&&Tuchong.get("photos/search/",{alb_id:n,per_page:16,page:t},a)}}function a(e,t){if("SUCCESS"==e.result){var i=twig({ref:"image-selector-items"}).render({photos:e.photos}).toString();s.el.find(".selector-choice").append(i),$(".selector-paginator").setPages(e.page,e.pages)}else alert(e.message)}function o(t){var i={img_id:t.data("image-id"),description:t.data("description"),source:{t:t.attr("src")}};if(e.find(".post[data-image-id="+i.img_id+"]").length)return void new InstantNotice("已经添加了这张照片",{target:$("#divImageBlocks"),offset:{left:400,top:80},style:{color:"#666"}});var a=twig({ref:"uploader-completed-item"}).render(i).toString();$(a).addClass("just-add").appendTo($(".uploader-image-list"));var o=$(".uploader-queue-item").length+$(".uploader-image-list .post").length;$(".form-groups-content")[o>1?"show":"hide"]()}var n={image_count:t.image_count,not_in_album_count:t.not_in_album_count,albumList:t.albums},s=openDialog("image-selector",n);s.el.delegate(".btn-primary","click",function(){return e.find(".just-add").removeClass("just-add"),s.close(),!1}).delegate(".btn-default","click",function(){return e.find(".just-add").remove(),s.close(),!1}).delegate(".selector-choice img","click",function(){var e=$(this);e.hasClass("selected")||o(e)});var r=s.el.find(".select-finder").change(function(){i(this.value)}),l=s.el.find(".selector-paginator").delegate(".prev-page","click",function(e){var t=l.data("page")-1;return t&&i(r.val(),t),!1}).delegate(".next-page","click",function(e){var t=l.data("page")+1;return t<=l.data("pages")&&i(r.val(),t),!1}).delegate("select","change",function(e){i(r.val(),this.value)});r.trigger("change")})}function loadSiteCard(){$("#siteCard").remove();var e=this,t=e.data("siteId");if(t&&t!=visitor.id){var i=$('<div id="siteCard"><div class="wrapper"></div></div>'),a=i.find("div");a.addClass(e.hasClass("user-anchor")||e.hasClass("user-icon")?"user":"group"),
i.css({left:-9999}).appendTo(document.body);var o,n,s={width:i.width(),height:i.height()},r=5,l=e.offset(),c=$(".container"),d=l.top-$(document).scrollTop(),p=c.width()-(l.left-c.offset().left);p>300?d>80?(o="down",n={left:l.left,top:l.top-s.height-15}):(o="up",n={left:l.left,top:l.top+e.height()+2*r}):(o="right",n={left:l.left-s.width-r,top:l.top-10}),i.css(n).data("direction",o),a.addClass(o),i.mouseleave(function(t){e.isMouseOn(t)||$(this).remove()}),i.mouseenter(function(){var e=i.data("timer");e&&(clearTimeout(e),i.data("timer",null))}),gSiteCards[t]?buildSiteCard(i,e,gSiteCards[t]):Tuchong.get("site/get/",{site_id:t},function(t){"SUCCESS"==t.result&&(gSiteCards[t.site.site_id]=t,buildSiteCard(i,e,t))})}}function buildSiteCard(e,t,i){i.tags=$.grep(i.site.tags,function(e){return $.trim(e).length>0});var a=twig({ref:"site-card"}).render(i).toString(),o=e.find(".wrapper"),n=e.data("direction");o.html(a).addClass("loaded"),o.delegate("a.mail","click",function(){return openDialog("new-message",{recipient:i.site.name}),!1}),"down"==n&&e.css("top",t.offset().top-e.height()-5)}function closeSiteCard(e){var t=$("#siteCard"),i=$(this);if(0!=t.length){var a=i.offset(),o=t.data("direction");if(!t.isMouseOn(e)){if(e.pageX<a.left+i.width()&&"right"==o||e.pageY<a.top+i.height()&&e.pageX>=a.left&&"down"==o||e.pageY>a.top&&e.pageX>=a.left&&"up"==o){var n=setTimeout(function(){t.data("timer")&&t.remove()},200);return void t.data("timer",n)}t.remove()}}}function getPageBar(e,t,i,a){i>a&&(i=a),1>i&&(i=1),pageStr="<span>共"+e+"条</span> | <span>"+i+"/"+a+"</span> | ",1==i?pageStr+="<span>首页</span><span> 上一页 </span>":pageStr+="<span><a href='javascript:void(0)' rel='1'> 首页 </a></span><span><a href='javascript:void(0)' rel='"+(i-1)+"'> 上一页 </a></span>",i>=a?pageStr+="<span> 下一页 </span><span> 尾页 </span>":pageStr+="<span><a href='javascript:void(0)' rel='"+(parseInt(i)+1)+"'> 下一页 </a></span><span><a href='javascript:void(0)' rel='"+a+"'> 尾页 </a> </span>",$("#pagecount").html(pageStr)}function renderNotifications(){var e="";$.each(notifications.unreadComments,function(t,i){e+=twig({ref:"unread-comment"}).render(i)}),$.each(notifications.unreadMentions,function(t,i){e+=twig({ref:"unread-mentions"}).render(i)}),$.each(notifications.unreadNoteLikes,function(t,i){e+=twig({ref:"unread-note-likes"}).render(i)}),$.each(notifications.pendingRequests,function(t,i){e+=twig({ref:"pending-requests"}).render(i)}),notifications.no_post_comments.authors.length>0&&(e+=twig({ref:"unread-comment"}).render(notifications.no_post_comments)),notifications.no_post_mentions.authors.length>0&&(e+=twig({ref:"unread-mentions"}).render(notifications.no_post_mentions)),notifications.visitor=visitor,e+=twig({ref:"unread-notifications"}).render(notifications),$(".notify-bar").html('<ul class="notify-list">'+e+'</ul><div class="read-all"><a href="javascript:void(0)" class="btn btn-sm btn-default">知道了</a></div>')[$(".notify-bar .notify-list li").length?"show":"hide"]()}function bindNotifyBarEvents(){$(".notify-bar").delegate(".x-delete","click",function(e){var t=$(this).closest("li");switch(!0){case t.hasClass("unread-followers"):TuchongClient.put("users/self/message",{type:"followers"},function(e){notifications.unread_followers=0},null,$.noop);break;case t.hasClass("unread-favorites"):TuchongClient.put("users/self/message",{type:"favorites"},function(e){notifications.unread_favorites=0},null,$.noop);break;case t.hasClass("unread-collections"):TuchongClient.put("users/self/message",{type:"collections"},function(e){notifications.unread_collections=0},null,$.noop);break;case t.hasClass("unread-requests"):TuchongClient.put("users/self/message",{type:"requests"},function(e){notifications.unread_requests=0},null,$.noop);break;case t.hasClass("unread-notifications"):TuchongClient.put("users/self/message",{type:"notifications"},function(e){notifications.unread_notifications=0},null,$.noop);break;case t.hasClass("unread-recommend_weibo_users"):TuchongClient["delete"]("sites/self",{},function(e){notifications.unread_notifications=0},null,$.noop);break;case t.hasClass("unread-comments"):TuchongClient.post("users/reading/comments",t.data(),function(e){delete notifications.unreadComments[t.data("postId")]},null,$.noop);break;case t.hasClass("unread-mentions"):TuchongClient.post("users/reading/mentions-comments",t.data(),function(e){delete notifications.unreadMentions[t.data("postId")]},null,$.noop);break;case t.hasClass("unread-note-likes"):TuchongClient.post("users/reading/note-likes",t.data(),function(e){delete notifications.unreadNoteLikes[t.data("postId")]},null,$.noop);break;case t.hasClass("unread-messages"):TuchongClient.put("users/self/message",{type:"messages"},function(e){notifications.unread_messages=0},null,$.noop)}0==t.siblings().length&&t.closest(".notify-bar").hide(),t.remove()}).delegate(".read-all a","click",function(){var e=$(".notify-list"),t=e.find("li[class^=unread], li.read-all");e.find("> li").length==t.length?(e.hide(),$(".notify-bar").hide()):t.hide(),t.find(".x-delete").trigger("click")})}function parseToModel(e){$.each(e.unreadComments||[],function(e,t){if(!t.post)return notifications.no_post_comments.authors=notifications.no_post_comments.authors.concat(t.authors),void(notifications.no_post_comments.site=t.site);var i=t.post.post_id;return notifications.unreadComments[i]?void(containAuthor(notifications.unreadComments[i].authors,t.authors[0])||notifications.unreadComments[i].authors.push(t.authors[0])):void(notifications.unreadComments[i]=t)}),$.each(e.unreadNoteLikes||[],function(e,t){if(t.post){var i=t.post.post_id;return notifications.unreadNoteLikes[i]?void(containAuthor(notifications.unreadNoteLikes[i].authors,unreadNoteLikes.authors[0])||notifications.unreadNoteLikes[i].authors.push(t.authors[0])):void(notifications.unreadNoteLikes[i]=t)}}),$.each(e.unreadMentions||[],function(e,t){if(!t.post)return notifications.no_post_mentions.authors=notifications.no_post_mentions.authors.concat(t.authors),void(notifications.no_post_mentions.site=t.site);var i=t.post.post_id;return notifications.unreadMentions[i]?void(containAuthor(notifications.unreadMentions[i].authors,unreadMentions.authors[0])||notifications.unreadMentions[i].authors.push(t.authors[0])):void(notifications.unreadMentions[i]=t)}),e.pendingRequests&&(notifications.pendingRequests=notifications.pendingRequests.concat(e.pendingRequests)),e.unread_favorites&&(notifications.unread_favorites+=e.unread_favorites),e.unread_collections&&(notifications.unread_collections+=e.unread_collections),e.unread_followers&&(notifications.unread_followers+=e.unread_followers),e.unread_messages&&(notifications.unread_messages+=e.unread_messages),e.unread_notifications&&(notifications.unread_notifications+=e.unread_notifications),e.unread_requests&&(notifications.unread_requests+=e.unread_requests),e.unread_recommend_weibo_users&&(notifications.unread_recommend_weibo_users+=e.unread_recommend_weibo_users)}function containAuthor(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t.id)return!0;return!1}function WSNotification(e,t){if(window.Notification&&"tuchong.com"===window.location.hostname&&"granted"!==Notification.permission){"denied"!==Notification.permission&&Notification.requestPermission();var i=this.socket=new WebSocket(e);i.onopen=function(e){i.send(JSON.stringify({user:t}))},i.onmessage=function(e){var t=JSON.parse(e.data);switch(t.type){case"home":parseToModel(t),renderNotifications();break;case"desktop":if(window.Notification&&"granted"===Notification.permission){var i=new Notification(t.title,t.options);i.onclick=function(){t.url&&window.open(t.url,"_blank")};var a=setTimeout(function(){i.close(),clearTimeout(a)},1e4)}}},i.onerror=function(e){console.error(e)}}}function registerFormInit(e){function t(){TuchongClient.post("captcha/image",{},function(e,t){i.el.find("input[name=captcha_id]").val(e.captchaId),i.el.find(".captcha-img").attr("src",e.captchaBase64),i.el.find("input[name=captcha_token]").val("")},function(e,t){alert(e.message)})}var i;TuchongClient.post("captcha/image",{},function(e,t){i=new Dialog(twig({ref:"dialogs/captcha"}).render({captchaId:e.captchaId,captchaUrl:e.captchaBase64}).toString())},function(e,t){alert(e.message)}),e.delegate(".changeRegMethod","click",function(t){var i=$(this).data("method");switch(e.removeClass("form-mobile form-email"),e.addClass("form-"+i),i){case"mobile":e.find("input[name=mobile_number]").attr("disabled",!1).focus(),e.find("input[name=user_email]").attr("disabled",!0);break;case"email":e.find("input[name=user_email]").attr("disabled",!1).focus(),e.find("input[name=mobile_number]").attr("disabled",!0)}}).delegate(".sendSMSBtn","click",function(a){return $btn=$(this),$btn.data("sending")||!e.find("input[name=mobile_number]").val()?void alert("请填写手机号"):(t(),void i.open().el.delegate("#captcha-dialog-close","click",function(){i.close(),$btn.data("sending",!1),$btn.text("免费获取短信验证码"),$btn.attr("disabled",!1)}).delegate("#captcha-dialog-confirm","click",function(){return i.el.find("input[name=captcha_token]").val()?($btn.text("发送中..."),$btn.data("sending",!0),$btn.blur(),void TuchongClient.post("captcha/sms",{mobile_number:e.find("input[name=mobile_number]").val(),zone:e.find("select[name=zone]").val(),captcha_id:i.el.find("input[name=captcha_id]").val(),captcha_token:i.el.find("input[name=captcha_token]").val()},function(e,t){return i.close(),"SUCCESS"===e.result?($btn.attr("disabled",!0),void countDown(12e4,1e3,function(e){$btn.text("还剩"+e/1e3+"秒可以重发")},function(){$btn.data("sending",!1),$btn.text("免费获取短信验证码"),$btn.attr("disabled",!1)})):void alert(e.message)},function(e,t){alert(e.message),i.close(),$btn.data("sending",!1),$btn.text("免费获取短信验证码")})):(alert("请填写上面图片中的验证码"),!1)}).delegate(".captcha-img","click",function(){t()}).find(".x-delete").remove())}),e.validate({rules:{mobile_number:{required:!0,chinesePhone:!0,remoteCheck:{check_url:"accounts/check-mobile/",fields:["zone","mobile_number"]}},mobile_captcha_token:{required:!0},captcha_token:{required:!0},user_name:{required:!0,remoteCheck:{check_url:"accounts/check-name/",fields:["user_name"]}},user_email:{required:!0,email:!0,remoteCheck:{check_url:"accounts/check-email/",fields:["user_email"]}},user_password:{required:!0,minlength:6},user_password2:{required:!0,equalTo:"input[name=user_password]"}},messages:{mobile_number:{required:"手机号不能为空",chinesePhone:"请正确输入11位的手机号码"},mobile_captcha_token:{required:"验证码不能为空"},captcha_token:{required:"验证码不能为空"},user_name:{required:"用户名不能为空",remoteCheckName:"用户名已经存在"},user_email:{required:"邮箱不能为空",email:"邮箱格式不正确"},user_password:{required:"密码不能为空",minlength:"密码长度至少需要6位"},user_password2:{required:"密码不能为空",equalTo:"两次输入的密码不一致"}},errorElement:"span",errorClass:"error-block",focusCleanup:!0,onkeyup:!1,submitHandler:function(){e.ajaxsubmit(local.operation)}})}function welcomeLoginFormInit(e){e.on("submit",function(t){return e.ajaxsubmit(local.operation,function(t,i,a){switch(t.result){case"ERROR":switch(t.code){case 11:e.find(".form-captcha").captcha();break;case 12:e.find(".form-captcha").captcha("refresh")}e.find(".login-message").html("<p>"+t.message+"</p>").show()}}),t.preventDefault(),!1})}function bindMobileFormInit(e,t){function i(){TuchongClient.post("captcha/image",{},function(e,t){a.el.find("input[name=captcha_id]").val(e.captchaId),a.el.find(".captcha-img").attr("src",e.captchaBase64),a.el.find("input[name=captcha_token]").val("")},function(e,t){alert(e.message)})}var a;t?e.delegate(".sendSMSBtn","click",function(t){$btn=$(this),$btn.text("发送中..."),$btn.data("sending",!0),$btn.blur(),TuchongClient.post("captcha/forget",{mobile_number:e.find("input[name=mobile_number]").val(),user_id:e.find("input[name=user_id]").val()},function(e,t){return"SUCCESS"===e.result?($btn.attr("disabled",!0),void countDown(12e4,1e3,function(e){$btn.text("还剩"+e/1e3+"秒可以重发")},function(){$btn.data("sending",!1),$btn.text("免费获取短信验证码"),$btn.attr("disabled",!1)})):void alert(e.message)},function(e,t){alert(e.message),a.close(),$btn.data("sending",!1),$btn.text("免费获取短信验证码")})}).on("submit",function(t){TuchongClient.post("captcha/verify",e.serialize(),function(e,t){"SUCCESS"===e.result&&(location.href=e.redirect)},function(e,t){alert(e.message),$btn.data("sending",!1),$btn.text("免费获取短信验证码")}),t.preventDefault()}):(TuchongClient.post("captcha/image",{},function(e,t){a=new Dialog(twig({ref:"dialogs/captcha"}).render({captchaId:e.captchaId,captchaUrl:e.captchaBase64}).toString())},function(e,t){alert(e.message)}),e.delegate(".sendSMSBtn","click",function(t){return $btn=$(this),e.find("input[name=mobile_number]").val()?(i(),void a.open().el.delegate("#captcha-dialog-close","click",function(){a.close(),$btn.data("sending",!1),$btn.text("免费获取短信验证码"),$btn.attr("disabled",!1)}).delegate("#captcha-dialog-confirm","click",function(){return a.el.find("input[name=captcha_token]").val()?($btn.text("发送中..."),$btn.data("sending",!0),$btn.blur(),void TuchongClient.post("captcha/sms",{mobile_number:e.find("input[name=mobile_number]").val(),zone:e.find("select[name=zone]").val(),captcha_id:a.el.find("input[name=captcha_id]").val(),captcha_token:a.el.find("input[name=captcha_token]").val()},function(e,t){return a.close(),"SUCCESS"===e.result?($btn.attr("disabled",!0),void countDown(12e4,1e3,function(e){$btn.text("还剩"+e/1e3+"秒可以重发")},function(){$btn.data("sending",!1),$btn.text("免费获取短信验证码"),$btn.attr("disabled",!1)})):void alert(e.message)},function(e,t){alert(e.message),a.close(),$btn.data("sending",!1),$btn.text("免费获取短信验证码")})):(alert("请填写上面图片中的验证码"),!1)}).delegate(".captcha-img","click",function(){i()}).find(".x-delete").remove()):void alert("请填写手机号")}))}function popCCEditor(e,t,i){var a=(i||"by-nc-sa").split("-"),o={};$.each(["by","nc","nd","sa"],function(e,t){o[t]=-1!==$.inArray(t,a)}),dialog=openDialog("cc-editor",{isOriginal:t,postId:e,cc:o});var n={by:"署名",nc:"非商业使用",nd:"禁止演绎",sa:"相同方式分享"},s=function(e){var t=$.map(e,function(){return n[this]});dialog.el.find(".choice img").attr("src","//static.tuchong.net/images/cc-"+e.join("-")+".png").attr("alt",e.join("-")),dialog.el.find(".choice span.desc").html(t.join("-"))};s(a),dialog.el.delegate(":radio","change",function(){var e=dialog.el.find(".cc-questions input[type=radio]").filter(function(){return this.checked&&this.value}).map(function(){return this.value}).toArray();s(["by"].concat(e))}),dialog.el.find("input[name=is_original]").change(function(){dialog.el.find(".dialog-body")[this.checked?"addClass":"removeClass"]("original")})}function moreExifDialog(e){return Tuchong.get("image/get-exif",{img_id:e},function(e){openDialog("exif",e)}),!1}function openShareWindow(e,t){var i,a=$(t).closest(".share-info"),o=a.data("url"),n=a.data("title"),s=a.data("pic").replace(/https/g,"http").replace(/\.webp/g,".jpg"),r=a.data("excerpt"),l=a.data("weiboUid"),c=a.data("authorName")||$(".post-header-info .site-anchor").text();switch(TuchongClient.post("user-operation",{device_id:"",os:"web",body:[{rqt_id:"",ot:"share",referer:$.getReferer(),position:$.getLocation(),extra:{post_id:a.data("postId"),type:"weibo"}}],info:null,ct:Date.now()/1e3},$.noop),-1==s.indexOf("||")&&(s=function(){var e=[];return $(".post-content article img,.figures-wrapper figure img").each(function(t,i){e.push($(i).attr("src").replace("https","http").replace(/\.webp/g,".jpg"))}),e.join("||")}()),c&&(c=" by @"+c+" ",l=""),n&&(n="【"+n+"】"),n.length+c.length+r.length>120&&(r=r.substring(0,120-(n.length+c.length))+"... "),r=n+r+c,o.replace("https","http"),e){case"weibo":i="http://service.weibo.com/share/share.php?"+buildQuery({url:o.replace("https","http"),appkey:2849947671,title:r,pic:s,ralateUid:l||""});break;case"qqt":i="http://v.t.qq.com/share/share.php?"+buildQuery({title:r,url:o,appkey:"9d072878eee44df79c5e66afac6f2892",pic:s,site:"http://tuchong.com"});break;case"renren":i="http://widget.renren.com/dialog/share?"+buildQuery({resourceUrl:o,images:s,description:r,charset:"utf-8",title:n});break;case"douban":i="http://www.douban.com/share/service?"+buildQuery({bm:1,image:s,href:o,updated:"",name:n});break;default:return""}return window.open(i,"","width=700, height=680, top=0, left=0, toolbar=no, menubar=no, scrollbars=no, location=yes, resizable=no, status=no")}!function(){var e=document.createElement("input");support={autofocus:"autofocus"in e,placeholder:"placeholder"in e,multiple:"multiple"in e,touch:"ontouchstart"in window,applicationcache:!!window.applicationCache,fullscreen:"fullscreen"in document||"webkitIsFullScreen"in document||"mozFullScreen"in document,localStorage:"localStorage"in window&&null!==window.localStorage,transition:function(){var t=["transition","WebkitTransition","MozTransition","MsTransition","OTransition"];for(var i in t)if(t[i]in e.style)return!0;return!1}()}}(),function(){"Microsoft Internet Explorer"==navigator.appName&&document.documentMode}();var $window=$(window);$.fn.setPlaceholder=function(){function e(e){""==t.val()&&t.val(t.attr("placeholder")).addClass("placeholder")}if(support.placeholder)return this;if("password"!=this.attr("type")){var t=this;this.focus(function(e){t.val()==t.attr("placeholder")&&t.val("").removeClass("placeholder")}),this.blur(e),this.submit(function(){t.val()==t.attr("placeholder")&&(t.val="")}),e()}return this},$.fn.freeze=function(){$.each($(this).find("button[type=submit]"),function(){this.disabled=!0}),$.each(this.find("input, select, textarea"),function(){this.readOnly=!0})},$.fn.unfreeze=function(){$.each($(this).find("button[type=submit]"),function(){this.disabled=!1}),$.each(this.find("input, select, textarea"),function(){this.readOnly=!1})},$.fn.ajaxsubmit=function(e,t){var i=this;i.find("input[type=password]").each(function(){var e=this.value;$(this).data("originValue",e),this.value=RSAPublicKeyEncrypt(encodeURIComponent(e))}),$.ajax({url:this.attr("action"),type:this.attr("method").toUpperCase(),data:this.serialize(),beforeSend:function(){i.freeze(),i.find("span.error-message").remove()},complete:function(){i.unfreeze(),i.find("input[type=password]").each(function(){this.value=$(this).data("originValue")})},success:$.checkResponse(e,t||function(e,t,a){switch(e.result){case"ERROR":switch(e.code){case 1:popLogin();break;case 11:i.find(".form-captcha").captcha();break;case 12:i.find(".ckeck_captcha_token").text(e.message).removeClass("hide"),i.find(".form-captcha").captcha("refresh");break;default:alert(e.message)}break;case"INVALID":$.each(e.messages,function(e){var t=$(i[0][e]),a=t.parent("dd").prev().text(),o=$.map(this,function(t){return a?t.replace("'"+e+"'",a):t});$('<span class="error-message"></span>').text(o.join(", ")).insertAfter(t)})}})})},$.fn.delayHover=function(e,t){var i,t=$.extend({delay:500,live:!1},t||{});return t.live?$(this).live({mouseenter:function(){var a=$(this);clearTimeout(i),i=setTimeout(function(){e.call(a)},t.delay)},mouseleave:function(){clearTimeout(i)}}):$(this).hover(function(){var a=$(this);clearTimeout(i),i=setTimeout(function(){e.call(a)},t.delay)},function(){clearTimeout(i)}),$(this)},$.fn.getSelection=function(e){if(!this.is("textarea")&&!this.is("input[type=text]"))return{};var t,i,a,o,n,s=this[0],r=0,l=0;return"number"==typeof s.selectionStart&&"number"==typeof s.selectionEnd?(r=s.selectionStart,l=s.selectionEnd):(i=document.selection.createRange(),i&&i.parentElement()==s&&(o=s.value.length,t=s.value.replace(/\r\n/g,"\n"),a=s.createTextRange(),a.moveToBookmark(i.getBookmark()),n=s.createTextRange(),n.collapse(!1),a.compareEndPoints("StartToEnd",n)>-1?r=l=o:(r=-a.moveStart("character",-o),r+=t.slice(0,r).split("\n").length-1,a.compareEndPoints("EndToEnd",n)>-1?l=o:(l=-a.moveEnd("character",-o),l+=t.slice(0,l).split("\n").length-1)))),{start:r,end:l}},$.fn.isMouseOn=function(e){var t=this,i=t.offset();return e.pageX>=i.left&&e.pageX<=i.left+t.width()&&e.pageY>=i.top&&e.pageY<=i.top+t.height()},$.fn.simpleTabs=function(){var e=this;e.click(function(t){e.removeClass("current"),$(this).addClass("current")})},$.fn.toggleChecked=function(){this.map(function(){this.checked=!this.checked})},$.fn.assembleToString=function(){return this.map(function(){return this.value}).get().join(",")},$.checkResponse=function(e,t){return function(i,a,o){if(null===i)alert(o.responseText);else if("object"==typeof i)switch(i.result){case"SUCCESS":(e||local.showNotice)(i,a,o);break;case"INVALID":case"ERROR":default:(t||local.alert)(i,a,o)}else alert(i)}},$.ajaxSetup({dataType:"json",timeout:2e4,beforeSend:function(e,t){},complete:function(e,t){},success:$.checkResponse(),error:function(e,t,i){switch(t){case"parsererror":alert(i),alert(e.responseText);break;case"error":break;case"timeout":case"notmodified":break;default:alert(t+i)}}});var Tuchong={};$.each(["post","get"],function(e,t){Tuchong[t]=function(e,i,a,o,n){$.ajax({url:"/api/"+e,type:t,data:i,success:$.checkResponse(a,o),error:n})}}),Date.prototype.toSimpleString=function(){var e=this.getHours(),t=this.getMinutes();return this.getMonth()+1+"-"+this.getDate()+" "+(e>9?"":"0")+e+":"+(t>9?"":"0")+t},Date.prototype.elapsedTime=function(e){var t=e||new Date-this.offset,i=(t-this)/1e3;return 10>i?"刚刚":60>i?Math.round(i)+"秒前":3600>i?Math.round(i/60)+"分钟前":86400>i?Math.round(i/3600)+"小时前":(new Date(t).getFullYear()==this.getFullYear()?"":this.getFullYear()+"年")+(this.getMonth()+1)+"月"+this.getDate()+"日"},Date.synchronize=function(e){Date.prototype.offset=new Date-new Date(e)},String.prototype.nl2br=function(){return this.replace(/\n/g,"<br />\n")},$.fn.eip=function(e,t,i){i=$.extend({editableCl:"editable",textareaCl:"textarea",minHeight:60,prompt:"<em>单击此处修改</em>"},i);var a=function(t){var a=$('<form action="'+e+' class="'+i.editableCl+' method="post"></form>').insertAfter(t).hide();for(param in this.params)a.append('<input type="hidden" name="'+param+'" value="'+this.params[param]+'" />');if($(t).data("id")&&a.append('<input type="hidden" name="id" value="'+$(t).data("id")+'" />'),$(t).hasClass(i.textareaCl)){var o=$('<textarea name="'+i.target+'"></textarea>').appendTo(a);$.browser.msie?o.set("text",t.innerHTML.replace(/<BR>/g,"\n")):o.html(t.innerHTML.replace(/<br>/g,"")),o.setStyle("height",(t.height()>i.minHeight?t.height():i.minHeight)+"px")}else a.append('<input type="text" name="'+i.target+'" value="'+t.innerHTML+'" />');return""==t.innerHTML&&t.html(i.prompt),a.append('<button type="reset" class="btn btn-sm btn-default">取消</button> <button type="submit" class="btn btn-sm btn-primary">保存</button>'),a.bind({submit:function(e){return e.stopPropagation(),$(t).empty().html('<img src="'+urls._m("/images/wait_short.gif")+'">').show(),a.ajaxsubmit(function(e,a){$(t).html(e.image[i.target].nl2br()||i.prompt)},local.alert),a.hide(),!1},reset:function(e){$(t).show(),a.hide()},keyup:function(e){"esc"==e.key&&(this.fireEvent("reset",e),this.reset()),"enter"==e.key&&e.control&&this.fireEvent("submit",e)}}),a};this.click(function(e){$(this).hide(),void 0===this.form&&(this.form=a(this)),this.form.show(),this.form[0][i.target].focus(),this.form[0][i.target].select()})};var gTimeout,InstantNotice=function(e,t){this.options=$.extend({target:$(document.body),offset:{left:0,top:0},style:{},icon:null,delay:1e3},t),clearTimeout(gTimeout);var i=$("#instantNotice").length?$("#instantNotice"):$('<div id="instantNotice"></div>');switch(i.hide().html(""),i.attr("class",""),this.options.icon){case"ERROR":this.el.addClass("attention");break;case"SUCCESS":this.el.addClass("success")}i.html(e);var a=this.options.target.offset();i.css(this.options.style).css({left:a.left+this.options.offset.left,top:a.top+this.options.offset.top}),i.appendTo(document.body).show(),gTimeout=setTimeout(' $("#instantNotice").hide() ',this.options.delay)},formatUnit=function(e){for(var t=["B","kB","MB","GB","TB"],i=0;e>=1024;)i++,e/=1024;return e.toFixed(2)+t[i]};$.fn.progressbar=function(e,t){"object"==typeof e&&(t=e,e="options");var i=this.find(".progressbar-value");switch(0==i.length&&(this.parent().find(".progress-compat").remove(),this.show(),i=$('<div class="progressbar-value ui-corner-left"></div>').appendTo(this)),e){case"value":var a=(t/this.data("total")*100).toFixed(0);i.toggle(t>0).toggleClass("ui-corner-right",t>=this.data("total")).width(a+"%");break;case"options":t.total&&this.data("total",t.total),i=$("<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>").appendTo(this)}},Date.parseDuration=function(e){var t={},i=Date.durations;for(var a in i){var o=Math.floor(e/i[a]);if(o&&(t[a]=o,!(e-=o*i[a])))break}return t},Date.fancyDuration=function(e){var t=[],i=Date.parseDuration(e);for(var a in i)t.push(i[a]+Date.durationsAbbr[a]);return t.join(", ")},Date.durations={years:31556926,months:2629743.83,days:86400,hours:3600,minutes:60,seconds:1,milliseconds:.001},Date.durationsAbbr={years:"年",months:"月",days:"天",hours:"小时",minutes:"分钟",seconds:"秒",milliseconds:"毫秒"},$.fn.fillOptions=function(e,t,i){this.empty(),this[0].options.add(new Option("",0,0==i));for(var a=e;a!=e+t;t>0?a++:a--)this[0].options.add(new Option(a,a,a==i));return void 0!==i&&this.val(parseInt(i)),this},$.fn.dateSelector=function(e){e=$.extend({start:2013,offset:-80},e);var t=function(e,t){return new Date(e,t,0).getDate()};this.each(function(){var i=$(this),a=$("<select></select>"),o=$("<select></select>"),n=$("<select></select>"),s=function(e){var s=a.val(),r=o.val(),l=n.val();n.fillOptions(1,t(s,r),l),i.val(s+"-"+(10>r?"0":"")+r+"-"+(10>l?"0":"")+l)};i.hide().change(function(s){var r=i.val().split("-");3!=r.length&&(r=[0,0,0]),a.fillOptions(e.start,e.offset,r[0]),o.fillOptions(1,12,r[1]),n.fillOptions(1,t(r[0],r[1]),r[2])}).trigger("change"),$.each([n,o,a],function(){this.change(s).insertAfter(i)})})};var local={alert:function(e,t,i){switch(e.result){case"SUCCESS":alert(e.message);break;case"ERROR":switch(e.code){case 1:popLogin();break;default:alert(e.message)}break;case"INVALID":$.each(e.messages,function(e){alert(e),alert(this)})}},update:function(e){return function(t,i){e.html(t.message)}},showNotice:function(e,t){new Notice(e.message,{icon:e.result})},showInstantNotice:function(e,t){new InstantNotice(e.message,{instant:!0,icon:e.result})},redirectInDialog:function(e,t){void 0!==e.redirect?location.href=e.redirect:"SUCCESS"==e.result&&(location.href=location.href.match(/^[^#]*/)[0]),dialog.setBody('<p class="center">'+e.message+" "+(e.hint||"")+"</p>"),dialog.setFooter('<button type="button" class="btn btn-sm btn-primary" onclick="dialog.close();">关闭</button>'),dialog.place()},showInDialog:function(e,t){dialog.options.ref&&dialog.hide(),dialog.setFooter('<button type="button" class="btn btn-sm btn-primary" onclick="if ( typeof interval != \'undefined\' ) clearInterval(interval); dialog.close();">关闭</button>'),void 0!==e.autoVanish?(countdown=2,dialog.setBody('<p class="center">'+e.message+'</p><p style="margin:1em 0 0; text-align:center;" class="countdown"><em>'+countdown+"</em>秒后自动关闭</p>"),interval=setInterval("dialog.el.find('.countdown em').text(--countdown); ",1e3),setTimeout(function(){clearInterval(interval),dialog.close()},2e3)):dialog.setBody('<p class="center">'+e.message+"</p>"),dialog.place()},operation:function(e,t){return void 0!==e.result&&"ERROR"==e.result?void new Notice(e.message,{icon:e.result}):void(void 0!==e.redirect?location.href=e.redirect:location.href=location.href.match(/^[^#]*/)[0])},goToNext:function(e,t){location.href=$(document.head).find("link[rel=next]").attr("href")},injectHTML:function(e,t,i){return function(a,o){switch(t){case"top":e.prepend(a);break;case"bottom":default:e.prepend(a)}i&&i.reset()}},showComment:function(e,t,i){return function(a,o,n){Date.synchronize(n.getResponseHeader("Date"));var s=$.map("next"==t?a.commentlist:a.commentlist.reverse(),function(e){return e.postUrl=a.baseUrl,i.render(e)}).join("");e.find(".comment-list, .comment-list-inline").html(s).addClass("loaded");var r=e.find(".comments-paginator");"first"==t&&r.removeClass("has-next").removeClass("has-prev");var l=a.commentlist.length;if(l)switch(t){case"first":e.data("beginNoteId",a.commentlist[l-1].note_id).data("endNoteId",a.commentlist[0].note_id),a.no_more_comment||r.addClass("has-prev");break;case"next":e.data("endNoteId",a.commentlist[l-1].note_id).data("beginNoteId",a.commentlist[0].note_id),a.no_more_comment&&r.removeClass("has-next"),r.addClass("has-prev");break;case"prev":default:e.data("beginNoteId",a.commentlist[0].note_id).data("endNoteId",a.commentlist[l-1].note_id),a.no_more_comment&&r.removeClass("has-prev"),r.addClass("has-next")}}},addMessage:function(e){return function(t){$("#messageList").prepend(twig({ref:"message"}).render(t).toString()),e&&e.reset()}},remove:function(e){return function(t,i){"SUCCESS"==t.result?e.fadeOut():alert(t.message)}},rate:function(e,t){$(this).find(".info").html("<big>"+e.score+"</big>分 (共"+e.ratecount+"人),我打了"+e.myscore+"分"),$(this).find(".rating").removeClass("show-tip")},dialogClose:function(e,t){dialog.close(),new Notice(e.message,{icon:"SUCCESS",delay:3e3})},progress:function(e,t){return function(i){var a="正在上传中："+formatUnit(i.loaded);i.lengthComputable&&(e.data("total",i.total).progressbar("value",i.loaded),a+="/"+formatUnit(i.total)),t.html(a)}},firstMultiPhoto:function(e,t){if(void 0!==e.result&&"ERROR"==e.result)return void new Notice(e.message,{icon:e.result});var i=openDialog("multi-photo");i.el.find(".multi-photo-btn").on("click",function(){location.href=e.redirect})}},ProgressTag={showTag:function(){if(this.options.inDialog){dialog.progressWrapper||(dialog.progressWrapper=$('<div class="progress-wrapper"></div>').prependTo(dialog));var e=dialog.progressWrapper}else{var e=$("#progressWrapper");e||(e=$('<div id="progressWrapper"></div>').prependTo(document.body))}this.tag||(this.tag=$('<span class="progress-tag"></span>').inject(e)),this.tag.html(this.options.message||"正在发送").show("inline"),document.body.style.cursor="progress"},hideTag:function(){document.body.style.cursor="auto",this.tag.hide()},showWaiting:function(e){},hideWaiting:function(e){}},urls={SCHEME:"//",APP_DOMAIN:window.app_domain||"tuchong.com",MEDIA_ROOT:window.media_root||"//s1.tuchong.net",PHOTO_ROOT:"//photo.tuchong.com",STYLE_ROOT:"//static.tuchong.net/style/default",MEDIA_FILES:/(\.gif)|(\.jpg)|(\.png)|(\.css)|(\.js)$/i,_:function(e){return 0===e.indexOf("/")?this.SCHEME+"www."+this.APP_DOMAIN+e:e},_u:function(){var e=$A(arguments);return 1==e.length?"string"==$type(e[0])?this._u(window.visitor,e[0]):this._u(e[0],"/"):2===e.length?0===e[1].indexOf("/")?this.SCHEME+(e[0].domain?e[0].domain:"space.tuchong.com/"+e[0].id)+e[1]:e[1]:void 0},_m:function(e){return 0===e.indexOf("/")?this.STYLE_ROOT+e:e},_p:function(e,t,i){return"view"==t?this._pv(e,i):this.PHOTO_ROOT+"/"+e.user_id+"/"+t+"/"+e.img_id+".jpg"},_pv:function(e,t){var i=this._("/photo/"+e.img_id+"/");return t&&(i+="&"+Hash.serialize(t)),i}},unloading=!1;window.beforeunload=function(){unloading=!0};var templates={},console=window.console||{info:function(){},log:function(){}};"pushState"in history||(history.pushState=function(){},history.replaceState=function(){});var locationOrigin=window.location.origin||window.location.protocol+"//"+window.location.host,rootDomainRoutes=Tuchong.rootDomainRoutes=[],subDomainRoutes=Tuchong.subDomainRoutes=[];rootDomainRoutes.addRoute=subDomainRoutes.addRoute=function(e,t){this.push({pattern:e,controller:t})};var Overlay=function(){$(".overlay").length>0?this.el=$(".overlay"):this.el=$('<div class="overlay"></div>').hide().appendTo(document.body)};Overlay.prototype.show=function(){this.place(),this.el.show()},Overlay.prototype.place=function(){this.el.hide(),this.el.css({width:$window.scrollLeft()>$window.width()?$window.scrollLeft():$window.width()+"px",height:$(document).height(),display:"block"})};var Dialog=function(e,t){this.options=$.extend({width:600,ref:!1,overlay:{duration:200,from:0,to:.7}},t),this.options.overlay&&(this.overlay=new Overlay),this.el=$(".dialog-wrapper").length?$(".dialog-wrapper"):$('<div class="dialog-wrapper"></div>'),void 0!==e&&(this.options.ref&&(this.placeholder=$("<div class='dialog-placeholder'></div>"),e.before(this.placeholder),this.content=e),
this.el.append(e))};Dialog.escKey=function(e){return 27==e.which?(dialog&&dialog.close(),!1):void 0},Dialog.prototype.open=function(){return this.overlay&&this.overlay.show(200),this.el.appendTo(document.body),this.place(),$(document).bind("keyup",Dialog.escKey),$('<a class="x-delete" href="javascript:void(0)">关闭</a>').click(function(){return dialog.close(),!1}).appendTo(this.el.find(".dialog")),this.el.show(),this},Dialog.prototype.place=function(){this.el.css({})},Dialog.prototype.close=function(e){$(document).unbind("keyup",Dialog.escKey),this.options.ref?(this.el.hide(),this.placeholder.before(this.content),this.placeholder.remove()):this.el.remove(),this.overlay&&this.overlay.el.hide()},Dialog.prototype.hide=function(e){this.options.ref&&(this.placeholder.before(this.content),this.placeholder.remove(),this.el.append("<div class='dialog'><div class='dialog-body'></div><div class='dialog-footer'></div></div>"),this.options.ref=!1)},Dialog.prototype.setBody=function(e){this.el.find(".dialog-body").html(e)},Dialog.prototype.setFooter=function(e){this.el.find(".dialog-footer").html(e)};var Notice=function(e,t){switch(this.options=$.extend({icon:null,closeable:!0,delay:0,redirect:!0},t),this.el=$('<div class="alert alert-dismissable"></div>'),this.options.icon){case"ERROR":this.el.addClass("alert-warning");break;case"SUCCESS":this.el.addClass("alert-success");break;default:this.el.addClass("alert-success")}$("<p></p>",{html:e}).appendTo(this.el),this.options.closeable&&(this.closeBtn=$('<button type="button" class="close" data-dismiss="alert" aria-hidden="true">关闭</button>').appendTo(this.el).click(this.hide)),this.show()};Notice.prototype.show=function(e){this.el.show().appendTo($("#header")),this.options.delay>0&&function(){this.el.hide()}.delay(this.options.delay),$("html, body").animate({top:this.el.scrollTop(),left:this.el.scrollLeft()})},Notice.prototype.hide=function(e){$(this).closest("div").hide()},function(e){e.getReferer=function(){var t=window.theatre,i="";return i=t?t.referer:e.getUrlPosition(document.referrer)},e.getLocation=function(){return e.getUrlPosition(location.href)},e.getUrlPosition=function(t){t||(t="");var i=t.match(/\/\/([\w-]+\.)?tuchong\.\w+(\/([\w-]+))?(\/([\w-]+))?/);if(!i)return"";var a=i[1],o=i[3],n=i[5];return a||o?a&&!o||!a&&e.isNumeric(o)&&"t"!=n&&!e.isNumeric(n)?"user":e.isNumeric(o)&&n?"detail":o:"feed"},window.pageReferer=e.getReferer(),window.pagePosition=e.getLocation()}($),function(e,t){var i=function(i){this.elementStack=[],this.extra=i,this.os=/mobile/gi.test(navigator.userAgent)?"wap":"web",this.impressionPosts=[],this.viewedPosts=[],t(e).on("beforeunload",t.proxy(function(){this.viewedPosts.length>0&&this.send("viewed"),this.impressionPosts.length>0&&this.send("impression")},this))};i.prototype.add=function(e){var t=this;e.each(function(e,i){t.elementStack.push(i)})};var a=e.innerHeight;i.prototype.analyze=function(){if(!(visitor.id<1))for(var i=Date.now(),o=0;o<this.elementStack.length;o++){var n=t(this.elementStack[o]),s=n.offset(),r=parseInt(n.css("height")),l=t(e).scrollTop();if(l>=s.top+r){if(this.elementStack.shift(),this.impressionPosts.length>0){var c=this.impressionPosts.shift();c.duration>500&&this.viewedPosts.push(c)}this.viewedPosts.length>=10&&this.send("viewed")}else{if(!(a+l>=s.top))break;var d=n.data("post-id"),p=n.data("request-id"),u=n.data("start");if(!d){this.elementStack.splice(o,1);continue}if(!u){n.data("start",i),this.impressionPosts.push({rqt_id:p||"",post_id:d,max_duration:0,duration:0,position:t.getLocation(),referer:t.getReferer(),extra:this.extra});continue}if(!this.impressionPosts[o])break;this.impressionPosts[o].duration=i-u>6e4?6e4:i-u}}},i.prototype.send=function(e){visitor.id<1||(this.impression(this[e+"Posts"]),this[e+"Posts"]=[])},i.prototype.reset=function(){this.elementStack=[]},i.prototype.impression=function(i){for(var a=i.length-1;a>=0;a--)i[a].duration<500&&i.splice(a,1);i.length<1||TuchongClient.post("post-impression",{user_id:e.visitor.id,device_id:"",os:this.os,body:i,info:null,ct:Date.now()/1e3},t.noop)},i.prototype.listenWindowScroll=function(){var i=this;t(e).scroll(function(){i.analyze()}).on("resize",function(){a=e.innerHeight})},e.ViewAnalytics=i}(window,$||jQuery);var Model={myAlbums:{},myGroups:{}};Model.myAlbums.add=function(e){$("select[name=alb_id]").each(function(){this.options.add(new Option(e.title,e.alb_id,!0)),this.value=e.alb_id})};var userOperations={follow:function(e){var t=$(this).closest(".site-actions");t.hasClass("following")?confirm("你确定要取消关注吗？")&&TuchongClient["delete"]("users/self/following/"+t.data("siteId"),{nonce:nonce,referer:$.getReferer(),position:$.getLocation()},function(){t.removeClass("following")}):TuchongClient.put("users/self/following/"+t.data("siteId"),{nonce:nonce,referer:$.getReferer(),position:$.getLocation()},function(){t.addClass("following")})},iconFollow:function(){var e=$(this);e.hasClass("following")?confirm("你确定要取消关注吗？")&&TuchongClient["delete"]("users/self/following/"+e.data("siteId"),{nonce:nonce,referer:$.getReferer(),position:$.getLocation()},function(){e.removeClass("following")}):TuchongClient.put("users/self/following/"+e.data("siteId"),{nonce:nonce,referer:$.getReferer(),position:$.getLocation()},function(){e.addClass("following")})}},imageOperations={removeFromAlbum:function(e){if(confirm("确定要从这个相册移除吗？")){var t=$(this).closest("li.image"),i=$(this).closest("ul.album");Tuchong.post("album/remove-image/",{alb_id:i.data("albumId"),img_id:t.data("imageId")},local.remove(t))}},setAsCover:function(e){var t=$(this).closest("li.image"),i=$(this).closest("ul.album");Tuchong.post("album/set-cover/",{alb_id:i.data("albumId"),img_id:t.data("imageId")},local.operation)},deleteImage:function(e){if(confirm("你确定要彻底删除这张照片吗？")){var t=$(this).closest("li.image");Tuchong.post("image/delete/",{img_id:[t.data("imageId")]},local.remove(t))}}},albumOperations={deleteAlbum:function(e){if(confirm("确定要删除这个相册吗（照片不会丢失）？")){var t=$(this).closest("li.album");TuchongClient["delete"]("albums/"+t.data("albumId"),{},local.operation)}},remove:function(e,t){confirm("确定要删除这个相册吗（照片不会丢失）？")&&TuchongClient["delete"]("albums/"+t,{},local.operation)},rename:function(e){var t=$(this).closest(".album");dialog=openDialog("edit-album",{alb_id:t.data("albumId"),title:t.data("title")}),dialog.el.find("form").submit(function(e){return $(this).ajaxsubmit(function(e,i){"SUCCESS"==e.result?(new Notice("更改相册名成功",{icon:"SUCCESS"}),t.find("h4 a ").text(dialog.el.find("input[name=title]").val())):new Notice("更改相册名失败",{icon:"ERROR"}),dialog.close()}),!1})}},postOperations={erase:function(e){var t=$(this).closest("li.post");return t.data("authorId")==t.data("siteId")?confirm("你确定删除这条图博吗？")&&Tuchong.post("post/delete/",{post_id:t.data("postId")},local.remove(t)):(dialog=openDialog("delete-reasons"),dialog.el.find(".dialog-body li a").click(function(){var e={post_id:t.data("postId")},i=$(this).text();return"不通知直接删除"!==i&&(e.reason=i),dialog.close(),Tuchong.post("post/delete/",e,local.remove(t)),!1})),!1},membership:function(e,t,i){var a=$(e.target).closest("li.post");return membershipDialog(t||a.data("authorId"),i||a.data("siteId")),!1},approve:function(e,t,i){var a=$(e.target).closest("li.post");return Tuchong.post("post/manage/",{post_id:t||a.data("postId"),site_id:a.data("siteId"),operation:"approve"},function(e){a.addClass("is-published").removeClass("is-rejected").removeClass("is-pending")}),!1},unapprove:function(e,t,i){var a=$(e.target).closest("li.post");return Tuchong.post("post/manage/",{post_id:t||a.data("postId"),site_id:a.data("siteId"),operation:"unapprove"},function(e){a.addClass("is-rejected").removeClass("is-published").removeClass("is-pending")}),!1},reply:function(e){var t=$(e.target).closest(".post"),i=t.next(".inline-comments");if(i[0]){var a=i.find("form");a.show(),a[0].content.focus(),scrollToBottom(a)}else showReplybox(t,!0);return!1}},replyOperations={submit:function(){var e=$(this),t=e.closest(".notes").find("ul");return e.ajaxsubmit(function(i){e.find("textarea").val("").blur(),$('<li><a class="user-anchor" rel="author" data-site-id="'+i.comment.author.site_id+'" href="'+i.comment.author.url+'">'+i.comment.author.name+"</a>"+i.comment.content+"<time>刚刚</time></li>").prependTo(t)},local.alert),!1}};atBoxOperations={init:function(){$("textarea").live("keyup",atBoxOperations.monitorInput),$(document.body).append('<div id="atBox"><ul></ul></div><div id="atBoxMonitor"></div>'),$("#atBox").delegate("li","click",function(){var e=$("#atBox"),t=e.data("el");cursorPos=e.data("cursorPos"),atPos=e.data("atPos");var i=t.val();t.val(i.substring(0,atPos+1)+$(this).text()+i.substr(cursorPos)),e.hide()})},monitorInput:function(e){var t=$(e.target),i=t.val(),a=t.getSelection().start,o=t.val().lastIndexOf("@",a),n=$("#atBox");if(-1==o)return void n.hide();var s=i.substring(0,o-1).split("@").length,r=i.substring(o+1,a);return""==r||r.indexOf(" ")>=0?void n.hide():void Tuchong.get("site/search/",{query:r,type:"user"},function(e){if("SUCCESS"==e.result){var i=n.find("ul");if(i.empty(),0==e.userlist.length)return void n.hide();atBoxOperations.locateAtBox(t,n,s),$.each(e.userlist,function(e,t){$("<li>"+t+"</li>").appendTo(i)}),n.show().data({atPos:o,cursorPos:a,el:t})}})},locateAtBox:function(e,t,i){var a=$("#atBoxMonitor");a.html(e.val().replace(/@/g,"<span>@</span>")).css(e.offset());var o=a.find("span").eq(i-1),n=o.offset();t.css({left:n.left+4,top:n.top+20})}};var headerUploadCallback=function(e,t){$("#siteBg").attr("src",e.site.header),$(":checkbox[name=useBg]").attr("checked",!0)},logoUploadCallback=function(e,t){$("#siteLogoBig").attr("src",e.site.logo.big)};Tuchong.RSA_PUBLICK_KEY="D8CC0180AFCC72C9F5981BDB90A27928672F1D6EA8A57AF44EFFA7DAF6EFB17DAD9F643B9F9F7A1F05ACC2FEA8DE19F023200EFEE9224104627F1E680CE8F025AF44824A45EA4DDC321672D2DEAA91DB27418CFDD776848F27A76E747D53966683EFB00F7485F3ECF68365F5C10C69969AE3D665162D2EE3A5BA109D7DF6C7A5",Tuchong.webp_enabled=getCookie("webp_enabled"),Tuchong.imageFormat="1"===Tuchong.webp_enabled?".webp":".jpg";var uploadControllerFile={onUploadStart:function(){},onUploadSuccess:function(e){"string"==typeof e&&(e=JSON.parse(e));var t=e.image.source.l;"webp"===t.slice(-4)&&(t=t.slice(0,-4)+"jpg");var i='<p><img data-image-id="'+e.image.img_id+'" src="'+t+'" alt="'+e.image.title+'"></p><br>';$("#editor").append(i)},checkMultiPhotos:function(){}};TuchongClient={},TuchongClient.restAPI="/rest/",$.each(["post","get","delete","put","patch"],function(e,t){TuchongClient[t]=function(e,i,a,o,n){$.ajax({url:TuchongClient.restAPI+encodeURI(e),type:t,data:i,success:$.checkResponse(a,o),error:n})}}),function(e){"use strict";var t={idGenUrl:"captcha/image",template:"form-captcha"},i=function(i,a){this.options=e.extend(this.options,t),e.isPlainObject(a)&&e.extend(this.options,a),i.data("options")&&e.extend(this.options,i.data("options")),this.$el=i,this.render()};i.prototype.render=function(){var e=this;TuchongClient.post(e.options.idGenUrl,{},function(t,i){e.$el.html(twig({ref:e.options.template}).render({captchaId:t.captchaId,captchaUrl:t.captchaBase64}).toString()),e.$el.find(".captcha-img").on("click",function(t){e.refresh()})},function(e,t){alert(e.message)})},i.prototype.refresh=function(){var e=this,t=this.$el.find(".captcha-img"),i=this.$el.find("input[name=captcha_id]");TuchongClient.post(e.options.idGenUrl,{},function(e,a){t.attr("src",e.captchaBase64),i.val(e.captchaId)},function(e,t){alert(e.message)})},e.fn.captcha=function(t){return this.each(function(){var a=e(this),o=a.data("captcha");o||(o=new i(a,t),a.data("captcha",o)),"string"==typeof t&&o[t]()})}}($||window.jQuery),$.fn.fileSubmit=function(e){e=$.extend({success:local.operation,error:local.alert,complete:$.noop,uploadProgress:$.noop},e);var t,i=this[0];if("undefined"==typeof XMLHttpRequest||"undefined"==typeof FormData||void 0===(t=new XMLHttpRequest).upload){var a="hidden-iframe-"+Math.round(1e6*Math.random());this.attr("target",a);var o=$('<iframe name="'+a+'" style="display:none;"></iframe>').insertAfter(this);i.submit(),o.load(function(t){e.complete(t);var i=(this.contentWindow||this.contentDocument).document;if(i.title){var a={"413 Request Entity Too Large":"文件尺寸过大","502 Bad Gateway":"服务器内部错误，请通知管理员","502 Bad Gateway":"服务器网关错误，请通知管理员"};alert(a[i.title]||i.title)}else handleResponse(i.body.innerHTML,$.checkResponse(e.success,e.error))})}else{var n=new FormData;$.each(this.serializeArray(),function(e,t){n.append(t.name,t.value)});var s=this.find("input[type=file]");n.append(s.attr("name"),s[0].files[0]),t.addEventListener("error",function(e){alert("连接不到服务器，请检查你的网络连接")},!1),t.addEventListener("load",function(t){e.complete(t);var i=t.target.status;if(i>=200&&300>i||304==i)handleResponse(this.responseText,$.checkResponse(e.success,e.error));else{var a={413:"文件尺寸过大",500:"服务器内部错误，请通知管理员",502:"服务器网关错误，请通知管理员"};alert(a[i]||t.target.statusText)}},!1),$.each(["abort","loadstart","loadend","progress","timeout"],function(){e[this]&&t.addEventListener(this,e[this],!1)}),t.upload.addEventListener("progress",e.uploadProgress,!1),t.open(this.attr("method").toUpperCase(),i.action,!0),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.send(n)}},$.fn.setPages=function(e,t){if(this.data("page",e).data("pages",t),t>1){var a=this.find("select").empty();for(i=1;i<=t;i++)a[0].options.add(new Option(i,i,i==e,i==e));this.show()}else this.hide()};var gSiteCards={},notifications={unreadComments:{},unreadNoteLikes:{},unreadMentions:{},pendingRequests:[],unread_favorites:0,unread_collections:0,unread_followers:0,unread_messages:0,unread_notifications:0,unread_requests:0,unread_recommend_weibo_users:0,no_post_comments:{authors:[],site:{}},no_post_mentions:{authors:[],site:{}}},refreshNotifications=function(){TuchongClient.get("users/self/notifications",{},function(e){parseToModel(e),renderNotifications()},null,$.noop)};$(function(){function e(){var e=navigator.userAgent.toLowerCase(),t=!!e.match(/Mobile/gi),i=!!e.match(/(iPad|iPhone|iPod)/gi),a=!!e.match(/WebKit/gi),o=i&&a&&!/CriOS/gi.test(e)&&!/FxiOS/gi.test(e)&&!/OPiOS/gi.test(e)&&!/mercury/gi.test(e),n="https://itunes.apple.com/cn/app/tu-chong-zui-hao-she-ying/id1073064739?l=en&mt=8",s="iOS";if(e.match(/Android/gi)&&(s="安卓",n=window.androidApk||"//static.tuchong.net/download/android/tuchong_v1.0.0.apk"),e.match(/micromessenger/gi)&&(n="http://a.app.qq.com/o/simple.jsp?pkgname=com.ss.android.tuchong"),t&&(!o||e.match(/micromessenger/gi)||e.match(/weibo/gi))){var r=i?"download-ios":"download-android";$('<div class="widget-applink"><img src="//s1.tuchong.com/content-image/c610e7d687050d21da4260369351eb04.png"><p class="applink-slogan"><strong>图虫</strong><br><span>你经常看到？何不点击下载！</span></p><a class="applink-link" href="'+n+'">下载APP</a><a class="applink-close" data-type="'+r+'"></a></div>').appendTo("body"),e.match(/weibo/gi)&&$(".applink-link").on("click",function(){alert("请用浏览器打开此链接")})}}var t=$(document.body);support.touch||t.addClass("no-touch"),Theatre.enabled()&&(Tuchong.rootDomainRoutes.addRoute(/^\/(\d+)\/(\d+)\/(#image(\d+))?/i,function(e,t,i,a){Theatre.controller(e,t,a)}),Tuchong.subDomainRoutes.addRoute(/^\/(\d+)\/(#image(\d+))?/i,function(e,t,i){Theatre.controller(null,e,i)}),t.delegate("a.theatre-view","click",function(e){var t,i,a,o=$(this);if(e.stopImmediatePropagation(),a=this.href.match(/\/\/[\w\d\-]+\.tuchong\.com\/(\d+)\//i))postId=a[1];else{if(!(a=this.href.match(/\/\/tuchong\.\w+\/(\d+)\/(\d+)\//i)))return void console.log(this.href+"找不到 postId");postId=a[2]}var n=this.href.match(/#image(\d+)$/i),s=!0;return n?(t=n[1],s=!1):t=o.data("imageId"),i=o.data("imageAuthorId"),Theatre.controller(o.data("siteId"),postId,t,i,s),history.pushState({},document.title,window.location.href),!1}));var i=locationOrigin.match(/\/\/tuchong\.\w+/i)?Tuchong.rootDomainRoutes:Tuchong.subDomainRoutes;t.delegate("a","click",function(e){if(!e.ctrlKey&&!e.shiftKey&&this.href){var t=this.href,a=t.match(/^(http|https):\/\/[\.\-\w\d]+/);if(a&&a[0]===locationOrigin)for(var a,o=t.replace(locationOrigin,""),n=0;n<i.length;n++)if(a=o.match(i[n].pattern))return Array.prototype.shift.call(a),i[n].controller.apply(window,a),history.pushState({},document.title,t),!1}}),$(window).on("popstate",function(e){if(e.originalEvent.state&&e.originalEvent.state.triggerTheatre)return document.title=e.originalEvent.state.title,void window.theatre.close();if(null!==e.originalEvent.state)for(var t,a=window.location.pathname,o=0;o<i.length;o++)if(t=a.match(i[o].pattern))return Array.prototype.shift.call(t),void i[o].controller.apply(window,t)}),t.delegate(".copyright-contextmenu","contextmenu",function(e){return alert($(this).data("copyright")),!1}).delegate(".icon-follow","click",userOperations.iconFollow).delegate(".btn-follow","click",userOperations.follow).delegate(".btn-recommend","click",function(){return Tuchong.post("following/like/",{site_id:$(this).closest(".site-actions").data("site-id"),referer:$.getReferer(),position:$.getLocation()},local.alert),!1}).delegate(".btn-message","click",function(){return openDialog("new-message",{recipient:$(this).closest(".site-actions").data("name")}),!1}).delegate(".tubo-images .more a","click",function(){var e=$(this).closest(".tubo-images");return e.find(".hide img").each(function(){this.src=$(this).data("src")}),e.find(".image-row").removeClass("hide"),$(this).parent().remove(),!1}).delegate(".btn-favorite, .post-actions .icon-like","click",function(e){function t(e){a[e?"addClass":"removeClass"]("is-favorite"),o.attr("title",e?"已分享":"分享")}function i(e){t("favorite"==e.favoriteStatus),a.find(".favorite-count").text(e.favoriteCount)}var a=$(this).closest(".post-actions"),o=$(this);return a.hasClass("is-mine")?alert("你不能分享自己的图博"):a.hasClass("is-favorite")?(t(!1),TuchongClient["delete"]("users/self/favorites/"+a.data("postId"),{referer:$.getReferer(),position:$.getLocation()},i)):(t(!0),TuchongClient.put("users/self/favorites/"+a.data("postId"),{referer:$.getReferer(),position:$.getLocation()},i)),!1}).delegate(".mark-as-read","click",function(e){var t=$(this).closest(".site-actions");Tuchong.post("post-notification/mark-groups-as-read/",{group_id:t.data("siteId")},function(){t.parent("li").fadeOut()})}).delegate(".groups-news-card .post-grid","click",function(){$(this).addClass("post-gray");var e=$(this).closest(".site-actions");e.find(".post-grid").length===e.find(".post-gray").length&&e.parent("li").fadeOut()}).delegate(".btn-scroll-to-reply","click",function(e){scrollToBottom($(".form-reply")),$(".form-reply")[0].content.focus()}).delegate(".btn-mark","click",function(){var e=$(this).closest(".tag-actions");$(this);return e.hasClass("is-marked")?(e.removeClass("is-marked"),Tuchong.post("tagmark/remove/",{tag_id:e.data("tagId")},local.operation)):(e.addClass("is-marked"),Tuchong.post("tagmark/create/",{tag_id:e.data("tagId")},local.operation)),!1}).delegate(".btn-repost","click",function(){return shareDialog(null,$(this).closest(".post-actions").data("post-id")),!1}).delegate(".share-bar .share-to-weixin","click",function(){openDialog("share-to-weixin",{url:location.href})}).delegate(".btn-collect","click",function(){return collectDialog(null,$(this).closest(".post-actions").data("post-id")),!1}).delegate(".btn-comments","click",function(e){var t=$(e.target).closest(".post"),i=t.parent().find(".comments-wrapper");if(i[0]){var a=i.find("form");a.show(),scrollToBottom(a),a[0].content.focus()}else showReplybox(t,!0);return!1}).delegate(".feed-share","click",shareDialog).delegate(".reply-content","focus",function(){$(this).closest(".form-reply").removeClass("collapsed")}).delegate(".form-reply","submit",function(e){var t=$(this);return t.ajaxsubmit(function(e,i,a){Date.synchronize(a.getResponseHeader("Date"));var o=twig({ref:"full-comment"}).render(e.comment).toString();t.closest(".comments-wrapper").find("ol, ul")["top"==t.data("where")?"prepend":"append"](o),t[0].content.value="",t[0].content.blur(),t.find(".reply-items").empty()},local.alert),!1}).delegate(".view-all-comments a","click",function(e){var t=$(e.target).closest(".comments-wrapper");return TuchongClient.get("posts/"+t.data("postId")+"/comments",{direction:"all",site_id:t.data("siteId"),type:"comment"},local.showComment(t,"prev",twig({ref:"comment"}))),!1}).delegate(".reply-comment","click",function(e){var t=$(this).closest("li[data-note-id]"),i=t.closest(".comments-wrapper").find(".form-reply"),a=t.data("authorName"),o=t.data("authorId");if(i.show(),i[0].content.focus(),void 0!==a&&void 0!==o){var n=i.find(".reply-items");if(0==n.find('input[value="'+o+'"]').length){var t=$('<span class="at-name" >'+a+'<a class="at-cancel">×</a><input type="hidden" name="replyto[]" value="'+o+'" /></span>');t.find(".at-cancel").click(function(){t.remove(),0==n.children("span").length&&n.css("display","none"),i[0].content.focus()}),n.append(t).css("display","block")}}return scrollToBottom(i),!1}).delegate(".delete-comment, .comment-list-inline .x-delete","click",function(e){var t=$(this).closest("li[data-note-id]");return confirm("你确定删除这条评论吗?")&&TuchongClient["delete"]("comments/"+t.data("noteId"),{referer:$.getReferer(),position:$.getLocation()},local.remove(t)),!1}).delegate(".like-comment","click",function(e){var t=$(this),i=t.closest("li[data-note-id]"),a=i.hasClass("liked");return i.toggleClass("liked"),a?TuchongClient["delete"]("comments/"+i.data("noteId")+"/likes/self",{referer:$.getReferer(),position:$.getLocation()},function(e){void 0!==e.likes&&t.html("赞同"+(e.likes?"("+e.likes+")":""))}):TuchongClient.put("comments/"+i.data("noteId")+"/likes/self",{referer:$.getReferer(),position:$.getLocation()},function(e){void 0!==e.likes&&t.html("已赞同("+e.likes+")")}),!1}).delegate(".btn-delete-post","click",function(e){$target=$(e.target),confirm("你确定要删除这个图博吗？")&&TuchongClient["delete"]("sites/"+$target.data("siteId")+"/posts/"+$target.data("postId"),{referer:$.getReferer(),position:$.getLocation()},function(e){alert(e.message),"SUCCESS"===e.result&&$target.parent(".post-grid").parent(".post").detach()})}).delegate(".switch-layout","click",function(e){var t=$(this).data("version");setCookie("version",t,14,"/"),window.location.reload()}).delegate(".export-event-imgs","click",function(e){$btn=$(this),$btn.data("export")||($btn.prop("disabled",!0),$btn.data("export",!0),$(".download-export-photos").remove(),TuchongClient.get("activity/"+$btn.data("eventId")+"/export",{},function(e){$btn.after($("<p>"+e.message+"</p>"))}))}).delegate(".activate-email","click",function(e){$btn=$(this),$btn.data("activating")||($btn.prop("disabled",!0),$btn.data("activating",!0),TuchongClient.post("users/self/activate-email",{},function(e){$btn.after($("<p>"+e.message+"</p>"))}))}).delegate(".btn-follow, .btn-recommend, .btn-message","click",checkLogin),window.console&&window.console.info&&window.console.info("一张网页，要经历怎样的过程，才能抵达用户面前？\n一位新人，要经历怎样的成长，才能站在技术之巅？\n探寻这里的秘密；\n体验这里的挑战；\n成为这里的主人；\n请将简历发送至 zhenyu@tuchong.com\n职位介绍：http://blog.tuchong.com/6205114/");var a=function(){};e(),$(".applink-close").on("click",function(){var e=$(this).parent();$.ajax({url:"/rest/users/self/tips",type:"PATCH",data:{type:$(this).data("type")},success:a,error:a}),e.remove()}),$(".card-warning .card-close").on("click",function(e){var t=$(this).parent();$.ajax({url:"/rest/users/self/tips",type:"patch",data:{type:t.data("type")},success:a,error:a}),t.remove()});var o=$.getLocation(),n=$(".navbar-subnav li").eq(1);"following"!=o&&"tags"!=o||"推荐"!=n.text()||n.addClass("has-news")}),$.fn.fullscreen=function(e){return"onfullscreenchange"in document?this.bind("fullscreenchange",e):"onwebkitfullscreenchange"in document?this.bind("webkitfullscreenchange",e):"onmozfullscreenchange"in document&&this.bind("mozfullscreenchange",e),this},$.fn.requestFullScreen=function(){var e=this[0];return e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen&&document.mozFullScreenEnabled?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen(),this},$.isFullscreen=function(){return"fullscreen"in document?document.fullscreen:"webkitIsFullScreen"in document?document.webkitIsFullScreen:"mozFullScreen"in document?document.mozFullScreen:!1},$.exitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()};var PostContainer=function(e,t){this.theatre=e,this.postId=t,this.el=$('<div class="post-container"></div>')};PostContainer.prototype.offset=function(e){if(this.currentIndex!=e)if(this.currentIndex<e){for(this.scenes.eq(this.currentIndex).removeClass("current-scene").addClass("prev-scene");this.currentIndex<e;this.currentIndex++)this.scenes.eq(this.currentIndex).removeClass("next-scene").addClass("prev-scene");this.scenes.eq(this.currentIndex).removeClass("next-scene").loadImages().addClass("current-scene")}else{for(this.scenes.eq(this.currentIndex).removeClass("current-scene").addClass("next-scene");this.currentIndex>e;this.currentIndex--)this.scenes.eq(this.currentIndex).removeClass("prev-scene").addClass("next-scene");this.scenes.eq(this.currentIndex).removeClass("prev-scene").loadImages().addClass("current-scene")}},PostContainer.prototype.getUrl=function(e){var t=locationOrigin;return t+=locationOrigin.match(/\/\/[\d\w\-\.]+\.tuchong\.com/i)?"/"+this.data.post.post_id+"/":"/"+this.data.post.site_id+"/"+this.data.post.post_id+"/",e&&(t+=this.currentIndex?"#image"+this.currentImageId:""),t},PostContainer.prototype.trackPV=function(){var e="tuchong.com/"+this.data.post.site.site_id+"/"+this.postId+"/"+(this.currentIndex?"#image"+this.currentImageId:"");(window._gaq=window._gaq||[]).push(["_trackPageview",e])},PostContainer.prototype.setTitle=function(){window.document.title=[this.data.post.title,this.data.post.site.name,"图虫摄影网"].join(" - ")},PostContainer.prototype.replaceState=function(){history.replaceState({controller:"theatre",siteId:this.data.post.site_id,postId:this.data.post.post_id},document.title,this.getUrl(!0))},PostContainer.prototype.pushState=function(){history.pushState({controller:"theatre",siteId:this.data.post.site_id,postId:this.data.post.post_id},document.title,this.getUrl(!0))},PostContainer.prototype.getIndex=function(e){var t=this.data.images;if(!e)return 0;if(1==t.length)return 0;for(var i=0;i<t.length;i++)if(t[i].img_id==e)return i+1;return 0},PostContainer.prototype.getLength=function(){return 1==this.data.images.length?1:this.data.images.length+1},PostContainer.prototype.changeScene=function(e){this.el;if(this.data)if("next"===e){if(this.currentIndex>=this.data.images.length||this.data.images.length<=1)return void this.theatre.changePost("older","first");this.offset(this.currentIndex+1),this.preloadScene(this.currentIndex+1),this.onSlide(),this.onNewScene()}else{if(0==this.currentIndex)return void this.theatre.changePost("newer","last");this.offset(this.currentIndex-1),this.preloadScene(this.currentIndex-1),this.onSlide(),this.onNewScene()}},PostContainer.prototype.onSlide=function(){var e=this;e.theatre.scrolling=!0,setTimeout(function(){e.theatre.scrolling=!1},500),1==this.data.images.length?this.currentImageId=this.data.images[0].img_id:this.currentImageId=this.currentIndex>0?this.data.images[this.currentIndex-1].img_id:null,this.theatre.refreshComments(),this.replaceState(),this.trackPV()},PostContainer.prototype.onNewScene=function(){var e=this.theatre.container;e.find(".progress-nav li.active").removeClass("active"),e.find(".progress-nav li").eq(this.currentIndex).addClass("active"),e.find(".post-meta-wrapper").html(this.imageMeta());var t=e.find(".bmap-container");if(t[0]){var i=new BMap.Map(t[0]),a=new BMap.Point(t.data("longitude"),t.data("latitude"));i.setMapType(BMAP_HYBRID_MAP),i.enableScrollWheelZoom(),i.centerAndZoom(a,8),i.addControl(new BMap.MapTypeControl),i.addOverlay(new BMap.Marker(a))}if(this.currentIndex==this.getLength()-1){var o=this.theatre.olderPostContainer;o&&o.preloadScene(0)}},PostContainer.prototype.onActive=function(){var e=this.theatre.container;this.preloadScene(this.currentIndex),this.preloadScene(this.currentIndex+1),this.preloadScene(this.currentIndex-1);var t=e.find(".progress-nav").empty().append(this.progressNav());t.css("margin-top",-t.height()/2+"px"),e.find(".sidebar-panel .post-actions-in-side").remove();for(var i=this.data.images,a=[],o=i.length-1;o>=0;o--)a.unshift(window.location.protocol+genImageUrl(i[o],"l"));e.find(".post-meta-wrapper").before($(twig({ref:"post-actions-panel"}).render({post:this.data.post,contentPost:this.data.originalPost?this.data.originalPost:this.data.post}).toString())),e.find(".share-info").data("postId",this.data.post.post_id).data("title",this.data.post.title).data("url",this.data.post.url).data("weiboUid",this.data.post.weibo_uid).data("authorName",this.data.post.author.name).data("excerpt",this.data.post.excerpt||this.data.images[0].excerpt).data("pic",a.join("||")),1==this.data.images.length?this.currentImageId=this.data.images[0].img_id:this.currentImageId=this.currentIndex>0?this.data.images[this.currentIndex-1].img_id:null,this.data.post.privileges.admin&&e.find(".comments-nav").html("阅读数："+this.data.post.views)},PostContainer.prototype.setContent=function(){var e=$(".current-post-container").find(".post-content"),t=e.find(".post-content-abstract").height();t>88&&e.addClass("content-hidden")},PostContainer.prototype.imageMeta=function(){var e=this.data;if(1===e.images.length){var t=e.images[0],i={post:e.originalPost?e.originalPost:e.post,image:t,exif:t.exif,images:e.images};return twig({ref:"post-image-meta"}).render(i).toString()}if(0==this.currentIndex)return twig({ref:"post-cover-meta"}).render({}).toString();var t=e.images[this.currentIndex-1];t.index=this.currentIndex;var i={post:e.originalPost?e.originalPost:e.post,image:t,exif:t.exif,images:e.images};return twig({ref:"post-image-meta"}).render(i).toString()},PostContainer.prototype.progressNav=function(){var e=this.data;if(1===e.images.length)return null;for(var t=[{title:"引言"}],i=this.getUrl(!1),a=1;a<=e.images.length;a++)t.push({title:"第"+a+"张",url:i+(0==a?"":"#image"+e.images[a-1].img_id)});var o=$(twig({ref:"progress-nav"}).render(t).toString());return o.find("li").eq(this.currentIndex).addClass("active"),o},PostContainer.prototype.preloadScene=function(e){var t=this.scenes.eq(e);return t?t.loadImages():!1},PostContainer.prototype.buildScene=function(){var e,t=this.data;if(1===t.images.length)e=twig({ref:"post-images"}).render([t.images[0]]).toString();else{e=twig({ref:"post-cover"}).render({post:t.post,originalPost:t.originalPost?t.originalPost:t.post,repostPost:t.originalPost?t.post:null,images:t.images,container_width:750,omit:3}).toString();for(var i=0;i<t.images.length;i++)e+=twig({ref:"post-images"}).render([t.images[i]]).toString()}var a=this.currentIndex;e=e.replace(/ src=/g," data-src="),this.scenes=$(e).filter(".post-scene").each(function(e){var t=$(this);a>e?t.addClass("prev-scene"):e==a?t.addClass("current-scene").loadImages():e>a&&t.addClass("next-scene")});var o=this.el.find(".current-scene")[0];o&&(this.scenes[a]=o),this.el.append(this.scenes)};var Theatre=Tuchong.Theatre=function(){this.scrolling=!1,this.currentPostContainer={},this.os=/mobile/gi.test(navigator.userAgent)?"wap":"web";var e=this;e.resize=function(){},e.onKeyUp=function(t){if(e.scrolling)return!1;switch(t.which){case 38:return e.currentPostContainer.changeScene("prev"),!1;case 40:return e.currentPostContainer.changeScene("next"),!1;case 37:return e.changePost("newer"),!1;case 39:return e.changePost("older"),!1;case 27:if(!e.triggerState)return;return e.close(),history.pushState({},document.title=e.triggerState.title,e.triggerState.url),!1}}};Theatre.enabled=function(){var e=1024;return window.screen.availWidth>e&&$(window).width()>e},Theatre.buildFromTemplate=function(e,t){var i=new Theatre;return i.container=$(twig({ref:"theatre"}).render({}).toString()).appendTo(document.body),i.mainStage=i.container.find(".main-stage"),i.currentPostContainer=new PostContainer(i,e),
i.currentPostContainer.el.addClass("current-post-container").appendTo(i.mainStage),i.initEvents(),i.triggerState=t,i},$.fn.loadImages=function(){return this.find("img").each(function(){var e=$(this);e.attr("src",e.data("src"))}),this},$.fn.postponeImages=function(){return this.find("img").each(function(){var e=$(this);e.data("src",e.attr("src")),e.attr("src","")}),this},Theatre.prototype.changePost=function(e,t){var i=this,a=function(e){var t=i.mainStage.find(".theatre-notice").html(e).css({visibility:"visible",opacity:1});setTimeout(function(){t.css("opacity",0),setTimeout(function(){t.empty().css("visibility","hidden")},200)},1500)};if(this.showNotice=a,"older"==e){if(null===i.olderPostContainer)return void a("已经是最旧一篇了");if(!i.olderPostContainer)return;"first"===t&&i.olderPostContainer.offset(0),i.newerPostContainer&&i.newerPostContainer.el.remove(),i.impression(i.currentPostContainer.data.post),i.newerPostContainer=i.currentPostContainer,i.newerPostContainer.el.removeClass("current-post-container").addClass("left-post-container"),i.currentPostContainer=i.olderPostContainer,i.currentPostContainer.el.removeClass("right-post-container").addClass("current-post-container"),i.currentPostContainer.data.post.startTime=Date.now(),i.referer="detail",i.olderPostContainer=void 0,i.mainStage.find(".navigate-newer").removeClass("forbid"),i.preloadPost("older")}else{if(null===i.newerPostContainer)return void a("已经是最新一篇了");if(!i.newerPostContainer)return;"last"===t&&i.newerPostContainer.offset(i.newerPostContainer.getLength()-1),i.olderPostContainer&&i.olderPostContainer.el.remove(),i.impression(i.currentPostContainer.data.post),i.olderPostContainer=i.currentPostContainer,i.olderPostContainer.el.removeClass("current-post-container").addClass("right-post-container"),i.currentPostContainer=i.newerPostContainer,i.currentPostContainer.el.removeClass("left-post-container").addClass("current-post-container"),i.currentPostContainer.data.post.startTime=Date.now(),i.newerPostContainer=void 0,i.mainStage.find(".navigate-older").removeClass("forbid"),i.preloadPost("newer")}i.initFromPage=void 0,i.scrolling=!0,setTimeout(function(){i.scrolling=!1},500),i.currentPostContainer.onActive(),i.currentPostContainer.onNewScene(),i.loadComments(),i.currentPostContainer.setTitle(),i.currentPostContainer.setContent(),i.currentPostContainer.pushState(),i.currentPostContainer.trackPV()},Theatre.prototype.initEvents=function(){var e=this,t=function(){$(document.body).css("overflow","hidden")};t(),e.container.on("mousewheel",function(e){});var i=null,a=!1,o=function(t){t.preventDefault();var o;if(void 0!==t.originalEvent.deltaY)o=t.originalEvent.deltaY;else if(void 0!==t.originalEvent.wheelDeltaY)o=t.originalEvent.wheelDeltaY/-40;else if(void 0!==t.originalEvent.wheelDelta)o=t.originalEvent.wheelDelta/-40;else{if(void 0===t.originalEvent.detail)return;o=t.originalEvent.detail}if(o!=-0){if(i&&clearTimeout(i),i=setTimeout(function(){a=!1},100),a)return;a=!0,setTimeout(function(){o>0?e.currentPostContainer.changeScene("next"):e.currentPostContainer.changeScene("prev")},150)}};"onmousewheel"in document?e.mainStage.on("mousewheel",o):"onwheel"in document&&e.mainStage.on("wheel",o),e.container.delegate("a.btn-close, .navigate-index","click",function(){return e.triggerState?(e.close(),history.pushState({},document.title=e.triggerState.title,e.triggerState.url),!1):(window.location.href=e.currentPostContainer.data.post.site.url,!1)}).delegate("a.btn-fullscreen","click",function(){return support.fullscreen?$.isFullscreen()?$.exitFullscreen():e.mainStage.requestFullScreen():(console.log("fullscreen not supported"),0==e.mainStage.css("right")?e.mainStage.css("right","320px"):e.mainStage.css("right",0)),!1}).delegate(".navigate-prev","click",function(){return e.currentPostContainer.changeScene("prev"),!1}).delegate(".navigate-next","click",function(){return e.currentPostContainer.changeScene("next"),!1}).delegate(".navigate-newer","click",function(){return e.changePost("newer"),!1}).delegate(".navigate-older","click",function(){return e.changePost("older"),!1}),e.container.delegate(".post-actions-in-side .btn-comments","click",function(){var e=$(this).closest(".sidebar-panel").find(".reply-content");return e.trigger("focus"),!1}).delegate(".exif-dialog-trigger","click",function(){var e=$(this).closest(".image-menu").data("imageId");e&&TuchongClient.get("images/"+e+"/exif",{},function(e){openDialog("exif",e)})}).delegate(".share-to-weixin","click",function(){TuchongClient.post("user-operation",{device_id:"",os:e.os,body:[{rqt_id:"",ot:"share",referer:$.getReferer(),position:$.getLocation(),extra:{post_id:e.currentPostContainer.data.post.post_id,type:"weixin"}}],info:null,ct:Date.now()/1e3}),openDialog("share-to-weixin",{url:e.currentPostContainer.getUrl()})}).delegate(".add-to-weibo-schedule-trigger","click",function(){TuchongClient.get("weibo-schedules/accounts",{},function(t){openDialog("add-to-weibo-schedule",{post_id:e.currentPostContainer.postId,weibo_users:t.response})})}).delegate(".see-all-content","click",function(t){openDialog("post-content",e.currentPostContainer.data.post)}),e.container.find(".comments-in-side").delegate(".reply-content","focus",function(){return 0==visitor.id?(popLogin(),!1):void $(this).closest(".form-reply").removeClass("collapsed")}),$(window).resize(e.resize).keyup(e.onKeyUp),e.resize(),$(document).fullscreen(function(){$.isFullscreen()?(console.log("is fullscreen"),e.mainStage.css("right",0)):(console.log("exit"),e.mainStage.css("right","320px"))})},Theatre.prototype.preloadPost=function(e){var t=this,i=this.currentPostContainer.data,a={site_id:i.post.site_id};a.time=i.post.published_at,a.direction="older"==e?"before":"after",TuchongClient.get("sites/"+a.site_id+"/posts/"+a.time+"/"+a.direction,{},function(i){var a=t[e+"PostContainer"]=new PostContainer(t,i.post.post_id);a.data=i,a.currentIndex=0,a.buildScene(),"older"==e?a.el.addClass("right-post-container"):a.el.addClass("left-post-container"),a.el.appendTo(t.mainStage),t.mainStage.find(".navigate-"+e).removeClass("forbid")},function(){t[e+"PostContainer"]=null,t.mainStage.find(".navigate-"+e).addClass("forbid")})},Theatre.prototype.impression=function(e){if(!(visitor.id<1)&&e.post_id){var t=Date.now()-e.startTime,i=[{rqt_id:e.request_id||"",post_id:e.post_id,max_duration:0,duration:t>3e5?3e5:t,position:"detail",referer:this.referer}];TuchongClient.post("post-impression",{user_id:visitor.id,device_id:"",os:this.os,body:i,info:null,ct:Date.now()/1e3},$.noop)}},Theatre.prototype.loadPost=function(){var e=this;TuchongClient.get("posts/"+this.currentPostContainer.postId,{},function(t){if(t.post){var i=e.currentPostContainer,a=i.data=t;i.currentIndex=i.getIndex(i.currentImageId),i.buildScene(),a.post.startTime=Date.now(),e.initFromPage?e.referer=$.getUrlPosition(document.referrer):e.referer=$.getUrlPosition(location.href),i.el.find("current-scene")[0]||i.preloadScene(i.currentIndex),i.onActive(),i.onNewScene(),i.setContent(),a.post.published_at&&(e.preloadPost("older"),e.preloadPost("newer")),e.initFromPage||(i.setTitle(),i.replaceState(),i.trackPV())}})},Theatre.prototype.close=function(){var e=this,t=function(){e.container.remove()};this.impression(this.currentPostContainer.data.post),$(document.body).css("overflow","auto"),t(),$(window).unbind("resize",e.resize).unbind("keyup",e.onKeyUp),$.exitFullscreen(),delete window.theatre},Theatre.prototype.show=function(){},Theatre.prototype.hide=function(){},Theatre.prototype.fastView=function(e,t){var i=[{img_id:t,user_id:e}];$(twig({ref:"post-images"}).render(i).toString()).addClass("current-scene").appendTo(this.currentPostContainer.el)},Theatre.prototype.refreshComments=function(){var e=0==this.currentPostContainer.currentIndex?null:this.currentPostContainer.currentImageId;this.container.find(".comments-in-side").find("input[name=image_id]").val(e);var t=this.container.find(".comment-list");t.find("li").hide(),e?(t.addClass("in-image"),t.find("[data-image-id="+e+"]").show()):(t.removeClass("in-image"),t.find("li").show())},Theatre.prototype.loadComments=function(){var e=this,t=this.currentPostContainer,i=e.container.find(".comments-in-side").empty();TuchongClient.get("posts/"+t.postId+"/comments",{type:"comment"},function(a,o,n){if(t===e.currentPostContainer){t.commentsInfo=a.commentlist;var s={post_id:t.postId,group_id:t.groupId,visitor:visitor,weiboAccount:weiboAccount};i.html(twig({ref:"fullscreen-comments"}).render(s).toString());var r=$.map(t.commentsInfo,function(e){return twig({ref:"full-comment"}).render(e)}).join("");i.find(".comment-list, .comment-list-inline").html(r).addClass("loaded"),e.refreshComments()}})},Theatre.prototype.processInit=function(e,t,i,a){var o=this.currentPostContainer;o.groupId=e,o.currentImageId=i,i&&a&&this.fastView(a,i),this.firstLoad()},Theatre.prototype.processExists=function(e,t,i,a){var o=this.currentPostContainer;return o.data&&o.postId==t?(o.offset(o.getIndex(i)),o.onSlide(),void o.onNewScene()):(o.postId!=t&&(o.postId=t,o.el.empty()),o.groupId=e,o.currentImageId=i,i&&a&&this.fastView(a,i),void this.firstLoad())},Theatre.prototype.firstLoad=function(){this.loadPost(),this.loadComments()},Theatre.controller=function(e,t,i,a,o){var n=window.theatre;n?n.processExists(e,t,i,a):(n=window.theatre=Theatre.buildFromTemplate(t,{title:document.title,url:window.location.href}),o&&(n.currentPostContainer.currentIndex=0),history.replaceState({triggerTheatre:!0,title:document.title},document.title,window.location.href),n.processInit(e,t,i,a))},function(e,t){function i(i,a){this.container=i,this.requestType=i.data("type"),this.tag=i.data("tag"),this.siteId=i.data("siteId"),this.isMobile=i.data("isMobile"),this.position=a.position,this.lastTime=a.lastTime,this.loadFinishTips=a.loadFinishTips,this.params={},this.loadTimes=1,this.preloadTimes=0,this.loading=!1,this.finish=!1;var o={};"user"==this.position?o.user_id=this.siteId:"tag"==this.position&&(o.tag_name=this.tag),visitor.id>0&&(this.analyze=new ViewAnalytics(o),this.analyze.listenWindowScroll());var n=this;this.container.find(".btn-posts-load-more").click(function(){n.loadPosts(),n.preloadTimes=0}),t(e).scroll(function(e){n.preloadCheck()})}i.prototype.loadPosts=function(){var e=this;e.container.find(".post-load-bar").addClass("loading"),"recommend"===this.requestType&&(this.requestUrl="recommend/"+encodeURIComponent(this.tag),1===this.loadTimes?this.params.type="last":this.params.type="next",this.params.limit=20),"history"!==this.requestType&&"new"!==this.requestType&&"weekly"!==this.requestType||(this.requestUrl="ajax-tags/"+encodeURIComponent(this.tag)+"/posts",this.params.type=this.requestType,this.params.limit=20,this.params.page=this.loadTimes),"sitePosts"===this.requestType&&(this.requestUrl="sites/"+this.siteId+"/posts/"+this.lastTime,this.params.limit=20);var i=location.search,a=decodeURIComponent;i&&(i=i.substr(1));for(var o=i.split("&"),n=0,s=o.length;s>n;n++){var r=o[n].split("=");"post_ids"==r[0]&&(this.params.post_ids=a(r[1]))}e.loading=!0,TuchongClient.get(this.requestUrl+"?"+t.param(this.params),{},function(i){var a={};a.isMobile=e.isMobile,a.posts=[],a.privileges=i.privileges,t.each(i.posts,function(e,t){t.images.length>0&&(t.mainImage=t.images.shift(),t.width=t.mainImage.width,t.height=t.mainImage.height,t.images.length>3&&t.images.splice(3,t.images.length-3)),a.posts.push(t)}),a.posts.length&&(e.lastTime=a.posts[a.posts.length-1].published_at);var o=t(twig({ref:"post-collage"}).render(a).toString());e.container.find(".post-row").append(o),initSortPostCollage(e.container.find(".post-row")),e.analyze&&(e.analyze.add(o.filter(".post-collage")),e.analyze.analyze()),0===a.posts.length?e.loadFinish():e.loadUnfinish(),e.loading=!1,++e.loadTimes})},i.prototype.preloadCheck=function(){var i=this;if(i.preloadTimes<2&&!i.loading&&!i.finish&&i.container.length){var a=i.container.offset().top+i.container.height(),o=t(e).scrollTop()+t(e).height();800>a-o&&(i.loadPosts(),++i.preloadTimes)}},i.prototype.reset=function(){this.loadTimes=1,this.preloadTimes=0,this.loading=!1,this.finish=!1,self.analyze&&this.analyze.reset(),this.container.find(".post-row").empty(),this.container.find(".post-row").css({minHeight:"0"}),this.container.find(".post-load-bar").removeClass("loading").removeClass("finish")},i.prototype.loadUnfinish=function(){this.container.find(".post-load-bar").removeClass("loading")},i.prototype.loadFinish=function(){this.container.find(".post-load-bar").removeClass("loading").addClass("finish"),this.container.find(".post-row").append('<div class="load-finish">'+this.loadFinishTips+"</div>"),this.container.find(".post-row").css({minHeight:0}),this.finish=!0},e.PostCollageLoader=i}(window,$||jQuery),Twig.extend(function(e){var t=e.filters.escape;e.functions.global=function(e){var t={visitor:visitor,weiboAccount:weiboAccount};return t[e]},e.filters.siteIcon=function(i){return i?e.Markup('<a href="'+i.url+'" title="'+t(i.name)+'" data-site-id="'+i.site_id+'" rel="author" class="site-icon" target="_blank"><img src="'+i.icon+'" alt="'+t(i.name)+'" /></a>'):""},e.filters.siteAnchor=function(i){return i?e.Markup('<a class="site-anchor" href="'+i.url+'" title="'+t(i.name)+'" data-site-id="'+i.site_id+'" target="_blank">'+t(i.name)+"</a>"):e.Markup('<a class="site-anchor" href="javascript:void(0);" title="匿名影友">匿名影友</a>')},e.filters.siteAnchors=function(i){for(var a=[],o=0;o<i.length&&7>o;o++)a.push('<a class="site-anchor" href="'+i[o].url+'" title="'+t(i[o].name)+'" data-site-id="'+i[o].site_id+'" target="_blank">'+t(i[o].name)+"</a>");return e.Markup(a.join("、")+(i.length>7?" 等":""))},e.filters.iconFollow=function(i){return i&&visitor.followingIdList&&i.site_id!=visitor.id?$.inArray(parseInt(i.site_id,10),visitor.followingIdList)>=0?"":e.Markup('<a class="icon-follow" href="javascript:void(0);" title="关注'+t(i.name)+'" data-site-id="'+i.site_id+'">关注</a>'):""},e.filters.tagAnchors=function(i){for(var a=[],o=0;o<i.length;o++)a.push('<a class="tag" rel="tag" href="'+web_root+"tags/"+encodeURIComponent(i[o])+'/">'+t(i[o])+"</a>");return e.Markup(a.join(" "))},e.filters.flagAnchors=function(i){for(var a=[],o=0;o<i.length;o++)a.push('<a class="tag">'+t(i[o])+"</a>");return e.Markup(a.join(" "))},e.functions.tuchongRoot=function(){return e.Markup(web_root)},e.filters.elapsedTime=function(t){var i=new Date(t.replace(/\-/g,"/"));return e.Markup(i.elapsedTime())},e.filters.timeTag=function(t){var i=new Date(t.replace(/\-/g,"/"));return e.Markup('<time pubdate datetime="'+t+'" title="'+t+'">'+i.elapsedTime()+"</time>")},e.filters.imageUrl=function(t,i){return e.Markup(genImageUrl(t,i))},e.filters.oneLine=function(e){return e.replace(/\n/g," ")},e.filters.excerptPlain=function(t){return e.Markup(t)},e.functions.hiddenNonce=function(){return e.Markup('<input type="hidden" name="nonce" value="'+nonce+'" />')},e.functions.figureRows=function(t,i){var a=[],o=[],n=0,s=2;return $.each(t,function(e){var r=this;n+=r.width/r.height,o.push(r);var l=Math.round((i.container_width-(o.length-1)*s)/n),c=o.length;if(e+1==t.length)for(;l>220*(c+6)/10;)c++,l=Math.round((i.container_width-(c-1)*s)/(n*c/o.length));if(220*(c+6)/10>=l){var d=(i.container_width-(c-1)*s)/c*o.length,p=a.length>=i.omit;a.push('<div class="image-row'+(p?" hide":"")+'" style="margin-bottom:'+s+'px;">'+$.map(o,function(e){var t=Math.round(d/n*e.width/e.height);return d-=t,n-=e.width/e.height,'<a href="'+i.post.url+"#image"+e.img_id+'" data-site-id="'+i.post.site_id+'" data-image-author-id="'+e.user_id+'" class="theatre-view" style="margin-right:'+s+'px;" target="_blank"><img style="height:'+l+"px;width:"+t+'px;" '+(p?"data-src":"src")+'="'+genImageUrl(e,"m")+'" onload="this.style.opacity = 1;" /></a>'}).join("")+"</div>"),o=[],n=0}}),a.length>i.omit&&a.push('<div class="more"><a title="显示全部" href="javascript:void(0)">共'+t.length+"张照片</a></div>"),e.Markup(a.join(""))},e.filters.toFixed=function(e,t){return isNaN(e)?"":e.toFixed(t)},twig({id:"activity-like-comment",data:'<li class="activity no-title{% if note.liked %} liked{% endif %}" data-site-id="{{currentSite.site_id}}" data-note-id="{{note.note_id}}">  <div class="activity-source">    {{ sites|siteAnchors }} 赞同评论    <time pubdate datetime="{{created_at}}" title="{{created_at}}">{{ created_at|elapsedTime }}</time>  </div>  <article class="card activity-card activity-comment-card">    <header class="activity-comment-header">      {{ note.author|siteIcon }}      {{ note.author|siteAnchor }}{{ note.author|iconFollow }}      <h4>        评论于:        <a href="{{post.url}}" target="_blank">{{ post.title|default(\'未命名\') }}</a>        {% if created_at %}        <time pubdate datetime="{{note.created_at}}" title="{{note.created_at}}">          <a href="{{post.url}}">{{ note.created_at|elapsedTime }}</a>        </time>        {% endif %}      </h4>    </header>    <div class="activity-comment-body"  data-note-id="{{note.note_id}}">      <div class="icon-st icon-quote-start"></div>      <blockquote class="quote-comment" >        {% if note.reply_to %}回复{{ note.reply_to|siteAnchors }}：{% endif %}{{ note.content|excerptPlain }}      </blockquote>    </div>    <footer class="activity-comment-footer">      <menu class="tubo-menu">        <li>          <a class="like-comment" href="javascript:void(0)">            {% if note.liked %}已赞同{% else %}赞同{% endif %}{% if note.likes %}({{note.likes}}){% endif %}          </a>        </li>      </menu>    </footer>  </article></li>'}),twig({id:"activity-like-site",data:'<li class="activity activity-like-site">  <div class="activity-source">    {{ sites|siteAnchors }} 推荐 {{ site|siteAnchor }}{{ site|iconFollow }}    <time pubdate datetime="{{created_at}}" title="{{created_at}}">{{ created_at|elapsedTime }}</time>  </div>  <article class="card activity-card activity-like-site" data-site-id="{{site.site_id}}">    <header></header>    <div class="wrapper">      {{ site|siteIcon }}      <p>{{site.description}}</p>    </div>    <footer>      <menu>{# 关注按钮 #}</menu>    </footer>  </article></li>'}),twig({id:"activity-post",data:'<li data-post-id="{{post.post_id}}">  {% if type == \'like-post\' %}  <div class="activity-source">    {{ sites|siteAnchors }} 分享    <time pubdate datetime="{{created_at}}" title="{{created_at}}">{{ created_at|elapsedTime }}</time>  </div>  {% endif %}  {% if type == \'repost\' %}  <div class="activity-source">    {{ post.site|siteAnchor }} 转发    <time pubdate datetime="{{created_at}}" title="{{created_at}}">{{ created_at|elapsedTime }}</time>  </div>  {% endif %}  <article class="card post tubo-bar" data-post-id="{{post.post_id}}" data-site-id="{{post.site_id}}" data-author-id="{{post.author_id}}">    <header class="tubo-header">      {{ contentPost.site|siteIcon }}      {{ contentPost.site|siteAnchor }}{{ contentPost.site|iconFollow }}      <h4>        {% if contentPost.title %}        <a href="{{post.url}}"{% if contentPost.isPhoto %} class="theatre-view" data-site-id="{{post.site_id}}"{% endif %} {% if contentPost.isSinglePhoto %}{% for item in contentPost.images %} data-image-id="{{item.img_id}}" data-image-author-id="{{item.user_id}}" {% endfor %}{% endif %} target="_blank">{{contentPost.title}}</a>        {% endif %}        {% if post.published_at %}        <time pubdate datetime="{{post.published_at}}" title="{{post.published_at}}">          <a href="{{post.url}}">{{ post.published_at|elapsedTime }}</a>        </time>        {% endif %}      </h4>    </header>    <div class="tubo-body" cite="{{post.url}}">    {% if contentPost.isText %}{# 文字 #}      {% if contentPost.image %}      <figure class="tubo-thumbnail pull-left">        <a href="{{post.url}}" target="_blank">          <img class="thumbnail" src="{{contentPost.image.src.s}}" alt="{{contentPost.image.title}}" />        </a>      </figure>      {% endif %}      <p class="summary">{{contentPost.excerpt}}</p>    {% endif %}        {% if contentPost.isSinglePhoto %}{# 单张 #}    {% set item = contentPost.images[0]%}      <figure class="tubo-thumbnail pull-left">        <a href="{{post.url}}" class="theatre-view" data-site-id="{{post.site_id}}" data-image-id="{{item.img_id}}" data-image-author-id="{{item.user_id}}" target="_blank">          <img class="thumbnail" src="{{ item|imageUrl(\'m\') }}" alt="{{item.title}}" style="max-height:270px;max-width:100%;" />        </a>      </figure>      {% if item.excerpt %}      <p class="summary">{{item.excerpt}}</p>      {% else %}      <p class="summary">{{contentPost.excerpt}}</p>      {% endif %}  {% endif %}  {% if contentPost.isMultiPhoto %}{# 组照 #}    {% if contentPost.excerpt %}      <p class="tubo-content">{{contentPost.excerpt}}</p>      {% endif %}      <div class="tubo-images">{{ figureRows(contentPost.images, _context) }}</div>      {% endif %}    </div>    <footer class="tubo-footer">      {% if contentPost.tags %}      <p class="tag-list">        <span class="icon-batch-small icon-st batch-tag-4"></span>        {{ contentPost.tags|tagAnchors }}      </p>      {% endif %}      <div class="tubo-menu post-actions{% if contentPost.is_favorite %} is-favorite{% endif %}" data-post-id="{{contentPost.post_id}}">        <a class="btn-comments" href="javascript:void(0)">评论{% if post.comments %}({{post.comments}}){% endif %}</a>        <a title="转发" class="btn-repost" href="javascript:void(0)">转发</a>        <a title="收藏" class="btn-collect" href="javascript:void(0)">收藏</a>        <a class="ir icon-like" title="{% if contentPost.is_favorite %}已分享{% else %}分享{% endif %}" href="javascript:void(0)">分享</a> <em class="favorite-count">{% if contentPost.favorites %}{{contentPost.favorites}}{% endif %}</em>      </div>    </footer>  </article></li>'}),twig({id:"comment",data:'<li data-note-id="{{note_id}}" data-author-id="{{author.site_id}}" data-author-name="{{author.name}}" {% if liked %} class="liked"{% endif %}>  <h5>    {% if author.url %}    <a rel="author" href="{{author.url}}" data-site-id="{{author.site_id}}">{{author.name}}</a>    {% else %}    <span>{{author.name}}</span>    {% endif %}    <time pubdate datetime="{{created_at}}" title="{{created_at}}">{{ created_at|elapsedTime }}</time>  </h5>  {% if author.url %}{{ author|siteIcon }}{% endif %}  <p>    {% if reply_to %}回复{{ reply_to|siteAnchors }}：{% endif %}    {% autoescape false %}    {{content}}    {% endautoescape %}    <a class="like-comment" href="javascript:void(0)">      {% if liked %}已赞同{% else %}赞同{% endif %}{% if likes %}({{likes}}){% endif %}    </a>    {% if reply %}    <a class="reply-comment" href="javascript:void(0)">回复</a>    {% endif %}    {% if delete %}    <a class="delete-comment" href="javascript:void(0);">删除</a>    {% endif %}  </p>  {% if groups %}    {% autoescape false %}    <p>来自 <a href="{{groups.url}}" target="_blank">{{groups.name}}</a></p>    {% endautoescape %}  {% endif %}</li>'}),twig({id:"form-captcha",data:'<label class="col-xs-2 control-label" for="captcha_token">验证码</label><div class="col-xs-3">  <input type="hidden" class="form-control" name="captcha_id" value="{{captchaId}}"/>  <input type="text" class="form-control" name="captcha_token" placeholder="请输入验证码" id="captcha_token" required/>  <span class="ckeck_captcha_token hide"></span></div><div class="col-xs-3">  <img src="{{captchaUrl}}" width="120px" class="captcha-img" alt="captcha"></div>'}),twig({id:"form-captcha-welcome",data:'<div class="col-xs-12" style="display: inline-block;width: 52%;">  <input type="hidden" class="form-control" name="captcha_id" value="{{captchaId}}"/>  <input type="text" class="form-control" name="captcha_token" placeholder="输入验证码" id="captcha_token" required/>  <span class="ckeck_captcha_token hide"></span></div><div class="col-xs-12" style="display: inline-block;width: 40%;">  <img src="{{captchaUrl}}" width="90px" class="captcha-img" alt="captcha"></div>'}),twig({id:"fullscreen-image",data:'<div id="theatre">  <div class="photo-layer-content">    <div class="photo-wrapper">      <a rel="previous" class="navigate-prev forbid" title="上一张" href="javascript:void(0);">上一张</a>      <a rel="index" class="navigate-index" title="关闭" href="javascript:void(0);">关闭</a>      <a rel="next" class="navigate-next forbid" title="下一张" href="javascript:void(0);">下一张</a>    </div>  </div>  <aside class="sidebar-panel">    <div class="post-meta-wrapper"></div>    <section class="comments-wrapper comments-in-side comments-darken"></section>    <div class="panel-toolbar">      <a class="icon-batch-small batch-cross btn-close" title="按ESC键也可以关闭哦" href="javascript:void(0);"></a>      {% if supportFullscreen %}      <a class="icon-batch-small batch-maximise-3 btn-fullscreen" title="全屏" href="javascript:void(0);"></a>      {% endif %}    </div>  </aside></div>'}),twig({id:"fullscreen-comments",data:'<form class="form-reply collapsed" action="/rest/posts/{{post_id}}/comments" method="post" data-where="top">  <input type="hidden" name="group_id" value="{{group_id}}" />  <input type="hidden" name="post_id" value="{{post_id}}" />  <input type="hidden" name="image_id" value="{{image_id}}" />  <div class="site-icon">    <img src="{{visitor.icon}}" alt="{{visitor.name}}"></div>  <p class="reply-items"></p>  <textarea name="content" class="reply-content" placeholder="别拦我，让我说句话……" title="Ctrl+Enter快捷提交" onkeyup="ctrlenterkey(this.form, event)"></textarea>  <div class="actions">    <button type="submit" class="btn btn-sm btn-primary">评论</button>    {% if weiboAccount %}    <label class="checkbox-inline">      <input type="checkbox" name="sync_to_weibo" />      同步到新浪微博    </label>    {% endif %}  </div></form><ul id="comments" class="comment-list"></ul><menu class="comments-paginator"></menu>'}),twig({id:"full-comment",data:'<li data-note-id="{{note_id}}" data-author-id="{{author.site_id}}" data-author-name="{{author.name}}" data-image-id="{% if image %}{{image.img_id}}{% endif %}" {% if liked %} class="liked"{% endif %}>  {% if anonymous %}  <span class="author-name">匿名影友</span>  {% else %}  <a href="{{author.url}}" data-site-id="{{author.site_id}}" class="author-name user-anchor" rel="note.author" >{{author.name}}</a>  {% endif %}  {% if not anonymous %}  <a data-site-id="{{author.site_id}}" href="{{author.url}}" title="{{author.name}}" rel="note.author" class="site-icon">    <img src="{{author.icon}}" alt="{{author.name}}" />  </a>  {% endif %}  <time pubdate datetime="{{created_at}}" title="{{created_at}}">{{ created_at|elapsedTime }}</time>  <div class="action">    {% if delete %}    <a class="delete-comment">删除</a>    {% endif %}  </div>  <p>    {% if reply_to %}回复{{ reply_to|siteAnchors }}：{% endif %}    {% autoescape false %}    {{content}}    {% endautoescape %}    <a class="like-comment" href="javascript:void(0)">      {% if liked %}已赞同{% else %}赞同{% endif %}{% if likes %}({{likes}}){% endif %}    </a>    {% if reply %}    <a class="reply-comment">回复</a>    {% endif %}  </p>  {% if groups %}    {% autoescape false %}    <p>来自 <a href="{{groups.url}}" target="_blank">{{groups.name}}</a></p>    {% endautoescape %}  {% endif %}  {% if image %}  <a href="{{postUrl}}#image{{image.img_id}}" class="theatre-view comment-image-thumbnail" data-site-id="{{site_id}}" data-image-author-id="{{image.user_id}}">    <img src="{{ image|imageUrl(\'t\') }}" alt="{{ image.excerpt|oneLine }}" />  </a>  {% endif %}</li>'}),twig({id:"image-selector-items",data:'{% for image in photos %}<img alt="{{image.title}}" title="{{image.title}}" src="{{image.source.t}}" data-image-id="{{image.img_id}}" data-description="{{image.description}}" />{% endfor %}'}),twig({id:"message",data:'<li>  {{ author|siteIcon }}  <a title="{{author.name}}" class="" href="{{author.url}}" data-site-id="{{author.site_id}}" target="_blank">{{author.name}}</a>  <time pubdate datetime="{{posted_at}}" title="{{posted_at}}">{{ posted_at|elapsedTime }}</time>  <p>    {% autoescape false %}    {{parsed_content}}    {% endautoescape %}  </p></li>'}),twig({id:"pending-requests",data:'<li class="pending-requests" data-site-id="{{site_id}}">  <a href="{{url}}settings/requests/">{{name}} 有{{pending_requests}}条申请等待处理</a></li>'}),twig({id:"post-actions-panel",data:'<section class="post-actions post-actions-in-side clearfix{% if post.is_favorite %} is-favorite{% endif %} {% if post.privileges.edit or post.privileges.delete or post.privileges.update or post.privileges.admin %} has-more-choice {% else %} nomore-choice {% endif %}" data-post-id="{{post.post_id}}">  <a title="分享" class="btn-favorite" href="javascript:void(0);">    <span class="icon-batch-small batch-heart-empty"></span>    <span class="icon-batch-small batch-heart-full"></span>    <span class="count favorite-count">      {% if contentPost.favorites %}{{contentPost.favorites}}{% endif %}    </span>  </a>  <a title="转发" class="btn-repost" href="javascript:void(0);">    <span class="icon-batch-small batch-options"></span>    <span class="count"></span>  </a>  <a title="收藏" class="btn-collect" href="javascript:void(0);">    <span class="icon-batch-small batch-star"></span>    <span class="count"></span>  </a>  <div class="btn-more dropdown">    <a class="" href="javascript:void(0);" data-toggle="dropdown">      <span class="icon-batch-small batch-ellipsis"></span>    </a>    <ul class="dropdown-menu" role="menu">      {% if post.privileges.edit %}      <li>        <a href="//tuchong.com/edit-post/{{post.post_id}}/">编辑</a>      </li>      {% endif %}    {% if post.privileges.delete %}      <li>        <a href="javascript:void(0);" onclick="confirm(\'你真的要删除这条图博吗？\') && TuchongClient.delete(\'posts/{{post.post_id}}\', {}, local.operation);return false;">删除</a>      </li>      {% endif %}    {% if post.privileges.admin %}      <li>        <a href="javascript:void(0);" class="add-to-weibo-schedule-trigger">推送到官方微博</a>      </li>    {% endif %}    {% if post.privileges.admin %}        <li>            <a href="http://admin.tuchong.org/#!/posts/edit/{{post.post_id}}" target="_blank">标记</a>        </li>    {% endif %}    {% if post.privileges.update %}        {% if post.type == \'text\' %}        <li><a href="javascript:void(0);" onclick="TuchongClient.patch(\'posts/{{post.post_id}}/conversion\', {\'type\':\'multi-photo\'}, local.operation);return false;">转换成组照</a></li>        {% endif %}        {% if post.type == \'multi-photo\'  %}        <li><a href="javascript:void(0);" onclick="TuchongClient.patch(\'posts/{{post.post_id}}/conversion\', {\'type\':\'text\'}, local.operation);return false;">转换成文字</a></li>        {% endif %}    {% endif %}    </ul>  </div>  <a class="btn-close" title="按ESC键也可以关闭哦" href="javascript:void(0);">    <span class="icon-batch-small batch-cross"></span>  </a></section>'}),twig({id:"post-collage",data:'{% for post in posts %}<div class="post-collage" data-post-id="{{post.post_id}}" data-width="{{ post.width }}" data-height="{{ post.height }}">    <a href="{{post.url}}" {% if post.type != \'text\' %}class="theatre-view"{% endif %} data-site-id="{{post.site_id}}" data-location="content" target="_blank">        {% if post.mainImage %}            <figure class="main-collage">                <img src="{{ post.mainImage|imageUrl(\'ft640\') }}" alt="post-cover"/>            </figure>            <div class="sub-collage">                {% for image in post.images %}                <figure class="sub-figure"><img src="{{ image|imageUrl(\'t\') }}" alt="post-cover"/></figure>                {% endfor %}            </div>        {% else %}            <article>                {{post.excerpt}}            </article>        {% endif %}    </a>    <div class="post-collage-footer">        <div class="post-author">            {{ post.site|siteIcon }}<span class="author-name">{{ post.title }}</span>            {% if post.image_count > 1 %}            <span class="image-count">{{ post.image_count }}张</span>            {% endif %}            {% if post.privileges.admin%}                {% if post.score %}                    {{post.score|toFixed(1)}}-{{post.views}}-{{post.impression}}                {% endif %}            {% endif %}        </div>    </div>    <div class="caption">		<h3>			<a href="{{post.url}}" {% if post.type != \'text\' %}class="theatre-view"{% endif %} data-site-id="{{post.site_id}}" data-location="content" target="_blank">{{post.title}}</a>			{% if post.image_count > 1 %}            <span class="image-count">{{ post.image_count }}张</span>            {% endif %}		</h3>				<div class="author-info">{{ post.site|siteAnchor }}</div>      {% if privileges.admin%}        {% if post.score %}          <h3>{{post.score|toFixed(1)}}-{{post.views}}-{{post.impression}}</h3>        {% endif %}        {% if post.reasons %}          <h3>            {% for reason in post.reasons %}              {{ reason }}            {% endfor %}          </h3>        {% endif %}      {% endif %}	</div></div>{% endfor %}'
}),twig({id:"post-cover",data:'<div class="post-scene post-cover">  {% if repostPost %}  <div class="post-origin">    {{ repostPost.author|siteIcon }}&nbsp      {{ repostPost.author|siteAnchor }}&nbsp&nbsp转发到&nbsp&nbsp      {{ repostPost.site|siteAnchor }}      {{repostPost.published_at|timeTag }}  </div>  {% endif %}  <div class="post-cover-wrapper">    <hgroup class="post-header-info">      {{ originalPost.author|siteIcon }}      {% if originalPost.title %}      <h1>{{originalPost.title}}</h1>      {% endif %}      {{ originalPost.author|siteAnchor }}&nbsp      {{originalPost.published_at|timeTag }}    </hgroup>    <div class="post-content">        <p class="post-content-abstract">        {% autoescape false %}        {{originalPost.parsedContent}}        {% endautoescape %}        </p>        <a class="see-all-content">查看全部</a>    </div>    <div class="post-tag">      <p>{{originalPost.flags|flagAnchors }}</p>      <p>{{ originalPost.tags|tagAnchors }}</p>    </div>    <div class="tubo-images">{{ figureRows(images, _context) }}</div>  </div></div>'}),twig({id:"post-cover-meta",data:""}),twig({id:"post-images",data:'{% for item in _context %}<div class="post-scene photo-wrapper" data-image-id="{{item.img_id}}">  <figure data-img-id="{{item.img_id}}">    <img src="{{ item|imageUrl(\'f\') }}" class="copyright-contextmenu" style="max-width:100%;height:auto;" data-copyright="&copy;版权所有" data-image-id="{{item.img_id}}" data-image-author-id="{{item.user_id}}" alt="{{item.description}}" />    <figcaption style="display:none">{{item.excerpt}}</figcaption>  </figure></div>{% endfor %}'}),twig({id:"post-image-meta",data:'<section class="post-site">  {{ post.author|siteIcon }}  {{ post.author|siteAnchor }}  &nbsp;<time pubdate="" datetime="{{post.published_at}}" title="{{post.published_at}}" style="display:inline-block;font-size:12px;">{{post.published_at|elapsedTime}}</time></section><section class="image-meta">  <h1 class="post-title"><a href="{{post.url}}" target="_blank">{{post.title}}</a>{% if images.length > 1 %}<span class="photo-count">{{image.index}}/{{images.length}}</span>{% endif %}</h1>  <p class="image-description">    {% autoescape false %}    {% if image.description %} {{image.description}} {% else %} {{post.parsedContent}} {% endif %}    {% endautoescape %}  </p></section>{% if images.length == 1 %}  <p>{{post.flags|flagAnchors }}</p>  <p>{{ post.tags|tagAnchors }}</p>{% endif %}{% if post.author.site_id != image.user.site_id %}<section class="post-site">  {{ image.user|siteIcon }}  {{ image.user|siteAnchor }}</section>{% endif %}<ul class="image-meta">{% if exif.new-photo %}  <li><span class="icon-batch-small batch-new-photo" title="机身"></span>{% if exif.new-photo.url %}<a href="{{exif.new-photo.url}}" class="meta-value" target="_blank">{{exif.new-photo.name}}</a>{% else %}<span class="meta-value">{{exif.new-photo.name}}</span>{% endif %}</li>{% endif %}{% if exif.lens %}  <li><span class="icon-batch-small batch-vinyl" title="镜头"></span>{% if exif.lens.url %}<a href="{{exif.lens.url}}" class="meta-value" target="_blank">{{exif.lens.name}}</a>{% else %}<span class="meta-value">{{exif.lens.name}}</span>{% endif %}</li>{% endif %}{% if exif.exposure %}  <li><span class="icon-batch-small batch-watch" title="曝光"></span><span class="meta-value">{{exif.exposure}}</span></li>{% endif %}{% if exif.taken %}  <li><span class="icon-batch-small batch-calendar" title="时间"></span><span class="meta-value">{{exif.taken}}</span></li>{% endif %}{% if exif.position %}  <li><span class="icon-batch-small batch-pin-2" title="位置"></span><a href="javascript:void(0);" class="meta-value">{{exif.position}}</a></li>{% endif %}</ul>{% if exif.position %}<div class="bmap-container" style="width:100%;height:135px;" data-longitude="{{exif.longitude}}" data-latitude="{{exif.latitude}}"></div>{% endif %}<ul class="image-menu" data-image-id="{{image.img_id}}">  <li><a href="javascript:void(0);" class="exif-dialog-trigger">全部EXIF信息</a></li>{% if image.privileges.download %}  <li><a href="{{tuchongRoot()}}photo/{{image.img_id}}/download/">下载原图</a>{% endif %}{% if image.privileges.admin %}  <li><a href="javascript:void(0);" class="" onclick="TuchongClient.post(\'welcome-images\', {post_id:{{post.post_id}}, img_id:{{image.img_id}} }, local.alert);return false;">设为全站首页</a>  <li><a href="{{post.plainUrl or \'javascript:void(0);\'}}" target="_blank">无格式展示</a>  {% if not post.push_outside %}  <li style="color: yellow;">该用户未授权第三方平台曝光</li>  {% endif %}{% endif %}</ul>'}),twig({id:"progress-nav",data:'<ul>  {% for item in _context %}  <li>    <a href="{{item.url}}">      <span class="dot"></span>      <span class="dot-stroke"></span>      <span class="progress-nav-text">{{item.title}}</span>    </a>  </li>  {% endfor %}</ul>'}),twig({id:"replybox",data:'<form class="form-reply" action="/rest/posts/{{post_id}}/comments" method="post" onreset="replyboxResetListener(this)">  <input type="hidden" name="format" value="json" />  <input type="hidden" name="group_id" value="{{group_id}}" />  <input type="hidden" name="post_id" value="{{post_id}}" />  <p class="reply-items"></p>  <textarea onfocus="replyboxFocusListener(this)" onblur="if (this.value == \'\') this.form.reset()" onkeyup="ctrlenterkey(this.form, event)" name="content" class="reply-content" title="Ctrl+Enter快捷提交" placeholder="别拦我，让我说句话……" /></textarea>    <div class="actions">    <button class="btn btn-sm btn-primary" type="submit">评论</button>    {% if weiboAccount %}    <label class="checkbox-inline">      <input type="checkbox" name="sync_to_weibo" />      同步到新浪微博    </label>    {% endif %}  </div></form>'}),twig({id:"site-timeline",data:'{% for item in visibleTimeNodes %}<div class="time-node {% if item.active %}active{% endif %}">    <div class="node-point"></div>    <div class="node-tips" data-toggle="filterPost" data-year="{{item.year}}" data-month="{{item.month}}">        <a href="{{item.url}}">{{ item.year }}.{{ item.month }}</a>        <div class="arrow-down"></div>    </div></div>{% endfor %}<div class="time-table-trigger direction-caret"></div><div class="time-table">    {% for year, months in timelineByYear %}    <div class="table-row">        <div class="year">{{ year }}</div>        <ul class="months">            {% for month in months %}            <li class="month {% if month.active %}active{% endif %}" data-toggle="filterPost" data-year="{{ month.year }}" data-month="{{ month.month }}"><a href="{{month.url}}">{{ month.month }}月</a></li>            {% endfor %}        </ul>    </div>    {% endfor %}</div>'}),twig({id:"site-selector-items",data:'<ul>  {% for site in siteList %}    <li style="font-size:14px;"><a href="javascript:void(0);" data-site-id="{{ site.site_id }}" data-user-id="{{ user_id }}"> {{ site.name }}{% if site.membership %} (已加入){% endif %}</a></li>  {% endfor %}</ul>'}),twig({id:"theatre",data:'<div id="theatre" class="theatre" data-post-id="{{post_id}}">  <main class="main-stage copyright-contextmenu" data-copyright="©版权所有">    <div class="theatre-notice"></div>    <a rel="previous" class="navigate-newer forbid" title="较新一篇(键盘 ← → 也可以翻页)" href="javascript:void(0);">      <span>较新一篇</span>    </a>    <a rel="index" class="navigate-index" title="关闭" href="javascript:void(0);">关闭</a>    <a rel="next" class="navigate-older forbid" title="较旧一篇(键盘 ← → 也可以翻页)" href="javascript:void(0);">      <span>较旧一篇</span>    </a>    <a class="navigate-prev ir" title="上一张(键盘 ↑ ↓ 也可以翻页)" href="javascript:void(0);">      <span>上一张</span>    </a>    <a class="navigate-next ir" title="下一张(键盘 ↑ ↓ 也可以翻页)" href="javascript:void(0);">      <span>下一张</span>    </a>    <div class="progress-nav"></div>    <div class="panel-toolbar">      <a class="icon-batch-small batch-maximise-3 btn-fullscreen" title="全屏" href="javascript:void(0);"></a>    </div>  </main>  <aside class="sidebar-panel">    <div class="post-meta-wrapper"></div>    <div class="post-toolbar"></div>    <div class="share-nav inner share-info">      分享到:<a onclick="openShareWindow(\'weibo\',this)" class="share-icon share-to-weibo"></a><a class="share-icon share-to-weixin"></a>    </div>    <div class="comments-nav inner"></div>    <section class="comments-wrapper comments-in-side comments-darken"></section>  </aside></div>'}),twig({id:"unread-comment",data:'<li class="unread-comments" data-site-id="{{site.site_id}}" data-post-id="{{post.post_id}}">  <span class="author">{{ authors|siteAnchors }}</span>  {% if post %}  在 <cite><a href="{{post.url}}">{{post.title}}</a></cite> 中回复你  {% else %}  给你 <a href="{{site.url}}profile/">留言了</a>  {% endif %}  <a class="x-delete">知道了</a></li>'}),twig({id:"unread-mentions",data:'<li class="unread-mentions" data-post-id="{{post.post_id}}" data-site-id="{{site.site_id}}">	<span class="author">{{ authors|siteAnchors }}</span>{% if post %}在 <cite><a href="{{post.url}}">{{post.title}}</a></cite> 中提到你{% else %}	<a href="{{site.url}}profile/"> 提到你</a>{% endif %}  <a class="x-delete">知道了</a></li>'}),twig({id:"unread-note-likes",data:'<li class="unread-note-likes" data-post-id="{{post.post_id}}">    <span class="author">{{ users|siteAnchors }}</span>{% if post %}赞同你在 <cite><a href="{{post.url}}">{{post.title}}</a></cite> 中的<a href="{{tuchongRoot()}}notes/likes/">评论</a>{% endif %}  <a class="x-delete">知道了</a></li>'}),twig({id:"unread-notifications",data:'{% if unread_messages %}<li class="unread-messages">  <a href="{{tuchongRoot()}}messages/">你有{{unread_messages}}条站内信</a>  <a class="x-delete">知道了</a></li>{% endif %}{% if unread_requests %}<li class="unread-requests">  <a href="{{tuchongRoot()}}requests/">{{unread_requests}}个新请求等待你处理</a>  <a class="x-delete">知道了</a></li>{% endif %}{% if unread_notifications %}<li class="unread-notifications">  <a href="{{tuchongRoot()}}notifications/">    你有 <em>{{unread_notifications}}</em>    条未读的通知  </a>  <a class="x-delete">知道了</a></li>{% endif %}{% if unread_followers %}<li class="unread-followers">  你有  <a href="{{visitor.url}}followers/">{{unread_followers}}位新关注者</a>  <a class="x-delete">知道了</a></li>{% endif %}{% if unread_favorites %}<li class="unread-favorites">  你的图博又被分享了  <a href="{{tuchongRoot()}}favorites/">{{unread_favorites}}次</a>  <a class="x-delete">知道了</a></li>{% endif %}{% if unread_collections %}<li class="unread-collections">  你的图博又被收藏了  <a href="{{tuchongRoot()}}notifications/collections/">{{unread_collections}}次</a>  <a class="x-delete">知道了</a></li>{% endif %}{% if unread_recommend_weibo_users %}<li class="unread-recommend_weibo_users">    新发现你有 {{unread_recommend_weibo_users}} 个微博好友也在图虫    <a href="{{tuchongRoot()}}lookup/weibo/">去看看</a>    <a class="x-delete">知道了</a></li>{% endif %}'}),twig({id:"unread-repost",data:'<li data-post-id="{{post.post_id}}" data-site-id="{{site.site_id}}" class="unread-reposts">  <span class="author">{{ authors|siteAnchors }}</span>  转发你的  <cite>    <a href="{{post.url}}">{{post.title}}</a>  </cite>  <a class="x-delete">知道了</a></li>'}),twig({id:"uploader-completed-item",data:'<li class="post file" data-image-id="{{img_id}}">  <input type="hidden" name="images[{{img_id}}][order]" value="0" />  <span class="thumb">    <img src="{{source.t}}" />  </span>  <div class="meta">    <textarea class="form-control description" name="images[{{img_id}}][description]" placeholder="照片描述">{{description}}</textarea>  </div>  <a class="ir btn-delete" href="javascript:void(0)">删除</a>  <a class="ir btn-sort" href="javascript:void(0)">排序</a></li>'}),twig({id:"uploader-uploading-item",data:'<div class="uploader-queue-item">  <div class="cancel">    <a>      <img src="//static.tuchong.net/styles/uploadify/cancel.png" border="0">    </a>  </div>  <span class="fileName">{{fileName}} ({{fileSize}})</span>  <span class="data">等待上传</span>  <div class="uploadifyProgress">    <div class="uploadifyProgressBar" style="width: 0;"></div>  </div></div>'}),twig({id:"dialogs/add-to-album",data:'<div class="dialog item-selector" id="albumSelector">  <form action="/api/album/add-to-albums/" method="post" onsubmit="$(this).ajaxsubmit(local.dialogClose);return false;">    <input type="hidden" name="img_id[]" value="{{img_id}}" />    <h2>添加到专辑</h2>    <div class="dialog-body">      <p class="center">正在载入</p>    </div>    <p class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">确定</button>    </p>  </form></div>'}),twig({id:"dialogs/add-to-weibo-schedule",data:'<div class="dialog">  <form action="/rest/weibo-schedules" method="post" onsubmit="$(this).ajaxsubmit(local.showInDialog, local.alert);return false;">    <input type="hidden" name="post_id" value="{{post_id}}" />    <h2>推送到微博</h2>    <div class="dialog-body">      <ul>        {% for key, value in weibo_users %}        <li>          <label>            <input type="radio" name="uid" value="{{key}}" />            {{value}}          </label>        </li>        {% endfor %}      </ul>    </div>    <p class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">确定</button>    </p>  </form></div>'}),twig({id:"dialogs/apply-to-join",data:'<div class="dialog" style="width:380px">  <form action="/rest/requests/join-groups" method="post" onsubmit="if (!this.description.value) {alert(\'申请理由不能为空\');return false;}$(this).ajaxsubmit(local.redirectInDialog,local.alert);return false;">    <input type="hidden" name="site_id" value="{{site_id}}" />    <input type="hidden" name="type" value="join_site" />    <h2>申请加入小组</h2>    <div class="dialog-body">      <p>请输入你的个人信息，申请理由</p>      <textarea name="description" style="width:90%" autofocus required></textarea>    </div>    <div class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">提交</button>    </div>  </form></div>'}),twig({id:"dialogs/captcha",data:'<div class="dialog" id="captcha-dialog" style="width: 340px;position:relative;background-image:none;background-color:#fff;"> 	<div>		<a href="#" id="captcha-dialog-close" style="position:absolute;right: 5px; top: 5px;width: 20px;text-align:center;text-decoration:none;color: #fff;">X</a>		<div>			<h4 style="text-align:center; background-color: #1788cf;height: 34px; line-height:24px;padding:5px;margin:0;font-size:14px;font-style:normal;color: #fff">请输入下图中的文字或字母</h4>		</div>		<div>			<div style="text-align:center;margin-top: 10px">				<input type="hidden" value="{{captchaId}}" name="captcha_id">				<img src="{{captchaUrl}}" class="captcha-img" style="width:180px;width: 180px;height: 40px;border: 1px solid #ccc;margin-bottom: 10px;cursor: pointer;">				<input type="text" name="captcha_token" id="captcha" maxlength="10" style="width:180px;height: 40px;border-radius: 2px;outline:none;">			</div>		</div>		<div style="display: block;text-align:center;padding: 10px 0;">			<input type="button" id="captcha-dialog-confirm" value="确定" style="height: 2.1em;padding: 0 1.16em 2px;border: 1px solid #c9c9c9;border-radius: 3px;background: transparent;outline:none;">		</div>	</div></div>'}),twig({id:"dialogs/cc-editor",data:'<div class="dialog cc-editor" style="width:500px">  <h2>共享协议设置</h2>  <form method="post" action="/api/post/update-cc/" onsubmit="$(this).ajaxsubmit(local.operation);return false;" onreset="dialog.close();">    <input type="hidden" name="post_id" value="{{postId}}" />    <input type="hidden" name="is_original" value="0" />    <div class="dialog-body{% if isOriginal %} original{% endif %}">      <p class="tip-original">        <label class="checkbox-inline">          <input type="checkbox" name="is_original" value="1"{% if isOriginal %} checked="checked"{% endif %}>这是我的原创作品</label>      </p>      <div class="cc-questions">        <p class="tip-nc">是否允许这张照片用于商业目的？</p>        <p>          <label class="radio-inline">            <input type="radio" name="part1" value=""{% if not cc.nc %} checked="checked"{% endif %}>是</label>          <label class="radio-inline">            <input type="radio" name="part1" value="nc"{% if cc.nc %} checked="checked"{% endif %}>否</label>        </p>        <p class="tip-nd">是否允许他人改编、演绎这张照片？</p>        <p>          <label class="radio-inline">            <input type="radio" name="part2" value=""{% if not cc.sa %}{% if not cc.nd %} checked="checked"{% endif %}{% endif %}>是</label>          <label class="radio-inline">            <input type="radio" name="part2" value="sa"{% if cc.sa %} checked="checked"{% endif %}>是, 只要他人以相同方式共享</label>          <label class="radio-inline">            <input type="radio" name="part2" value="nd"{% if cc.nd %} checked="checked"{% endif %}>否</label>        </p>        <p class="choice">          <img alt="" src="" />          <span class="desc"></span>        </p>      </div>    </div>    <div class="dialog-footer">      <button type="reset" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">保存</button>    </div>  </form></div>'}),twig({id:"dialogs/comments",data:'<div class="dialog dialog-repost dialog-large">  <h2 class="card-header">    <span>评论</span>    <a class="x-delete" href="javascript:void(0)">关闭</a>  </h2>  <section class="dialog-comments comments-wrapper post-comments" data-site-id="" data-post-id="">    <ul id="comments" class="comment-list"></ul>    <div class="dialog-footer">      <form class="form-reply collapsed clearfix" action="/rest/posts/{{post_id}}/comments" method="post" data-where="top">        <input type="hidden" name="post_id" value="{{post_id}}">        <div class="site-icon">          <img src="//s1.tuchong.net/sites/106/106543/logo_small.jpg?5" alt="Leonnoard"></div>        <p class="reply-items"></p>        <textarea name="content" class="reply-content" placeholder="期待你的精彩评论" title="Ctrl+Enter快捷提交" onkeyup="ctrlenterkey(this.form, event)"></textarea>        <div class="actions" style="">          <button type="submit" class="btn btn-sm btn-primary pull-right">评论</button>          <label class="checkbox-inline pull-right">            <input type="checkbox" name="sync_to_weibo">同步到新浪微博</label>          <label class="checkbox-inline pull-right">            <input type="checkbox" name="">匿名评论</label>        </div>        <div class="" style="padding-top:6px;">          <span>想法长篇大论？</span>          &nbsp;          <a>什么是回应?</a>          &nbsp;&nbsp;          <a>发布回应</a>        </div>      </form>    </div>  </section></div>'}),twig({id:"dialogs/create-album",data:'<div class="dialog" style="width:500px">  <form class="form-horizontal" action="/rest/albums" method="post" onreset="dialog.close();return false;">    <input type="hidden" name="type" value="album" />    {{hiddenNonce()}}    <h2>创建新相册</h2>    <div class="dialog-body">      <div class="form-groups">        <label class="col-xs-2 control-label">标题</label>        <div class="col-xs-10">          <input type="text" class="form-control" name="title" autofocus />        </div>      </div>      <div class="form-groups">        <label class="col-xs-2 control-label">描述</label>        <div class="col-xs-10">          <textarea class="form-control" name="description" onkeyup="ctrlenterkey(this.form, event)"></textarea>        </div>      </div>    </div>    <p class="dialog-footer">      <button type="reset" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">确定</button>    </p>  </form></div>'}),twig({id:"dialogs/delete-reasons",data:'<div class="dialog" style="width:300px">  <h2>删除理由</h2>  <div class="dialog-body" style="padding:20px 50px">    <p>选择删除理由通知作者</p>    <ul style="font-size:14px;">      <li>        <a href="javascript:void(0);">不符合本小组的主题</a>      </li>      <li>        <a href="javascript:void(0);">疑似广告</a>      </li>      <li>        <a href="javascript:void(0);">重复发布</a>      </li>      <li>        <a href="javascript:void(0);">请注意内容质量</a>      </li>      <li>        <a href="javascript:void(0);">不通知直接删除</a>      </li>    </ul>    <p>      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>    </p>  </div></div>'}),twig({id:"dialogs/direct-join-groups",data:'<div class="dialog" style="width:380px">  <form action="/api/membership/join/" method="post" onsubmit="$(this).ajaxsubmit(local.operation,local.alert);return false;">    <input type="hidden" name="site_id" value="{{site_id}}" />    <h2>加入小组的理由</h2>    <div class="dialog-body">      <p>说说你申请加入的理由</p>      <textarea name="description" style="width:90%" autofocus required placeholder="不写理由有可能会被管理员开除哟"></textarea>    </div>    <div class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">提交</button>    </div>  </form></div>'}),twig({id:"dialogs/edit-album",data:'<div class="dialog" style="width:400px">  <form class="form-horizontal" action="/rest/albums/{{alb_id}}" method="patch" onreset="dialog.close();return false;">    <input type="hidden" name="type" value="album" />    <input type="hidden" name="alb_id" value="{{alb_id}}" />    {{hiddenNonce()}}    <h2>修改相册名</h2>    <div class="dialog-body">      <div class="control-groups">        <label class="col-xs-2 control-label">相册名:</label>        <div class="col-xs-10">          <input type="text" class="form-control" name="title" value="{{title}}" autofocus />        </div>      </div>    </div>    <p class="dialog-footer">      <button type="reset" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">确定</button>    </p>  </form></div>'}),twig({id:"dialogs/exif",data:'<div class="dialog dialog-exif">  <h2>EXIF信息</h2>  <div class="dialog-body">    {% for key, value in exif %}    <h3>{{key}}</h3>    <ul class="exif-info clearfix">      {% for item in value %}      <li class="exif-row">        <label class="exif-desc">{{item.desc}}</label>        <div class="exif-content">{{item.content}}</div>      </li>      {% endfor %}    </ul>    {% endfor %}  </div></div>'}),twig({id:"dialogs/image-selector",data:'<div id="divImageBlocks" class="dialog tc-img-selector">  <h2>    从相册中选择    <a class="x-delete" href="javascript:void(0)" onclick="$( \'.image-list .just-add\' ).remove();dialog.close();">取消</a>  </h2>  <div class="dialog-body">    <p>      <select class="select-finder">        <option value="all" selected="selected">所有照片 ({{image_count}})</option>        {# TODO 根据时间选择图片  #}        <option value="not_in_album">未分类的照片 ({{not_in_album_count}})</option>        <optgroup label="我的相册">          {% for album in albumList %}          <option value="album-{{album.alb_id}}">{{album.title}} ({{album.imagecount}})</option>          {% endfor %}        </optgroup>        {# 原来还支持从收藏夹中选择 #}      </select>    </p>    <div class="selector-choice">请从上面的相册列表中选择你想显示的相册,并点击要插入的照片</div>  </div>  <div class="dialog-footer">    <span class="selector-paginator">      <a href="#" class="prev-page">上一页</a>      <select></select>      <a href="#" class="next-page">下一页</a>    </span>    <button class="btn btn-sm btn-primary">确定</button>    <button class="btn btn-sm btn-default">取消</button>  </div></div>'}),twig({id:"dialogs/login",data:'<div class="dialog" id="popLogin" style="width:380px">  <form class="form-horizontal" action="/rest/accounts/login" method="post" onsubmit="$(this).ajaxsubmit(local.redirectInDialog);return false;">    <h2>登录</h2>    <div class="dialog-body" style="padding-bottom:30px">      <div class="form-groups">        <label class="col-xs-2 control-label" for="popLoginAccount">账号</label>        <div class="col-xs-10">          <input type="text" class="form-control" name="account" id="popLoginAccount" autofocus required placeholder="邮箱、手机、用户名"/>        </div>      </div>      <div class="form-groups">        <label class="col-xs-2 control-label" for="popLoginPassword">密码</label>        <div class="col-xs-10">          <input type="password" class="form-control" name="password" id="popLoginPassword" required />        </div>      </div>      <div class="form-groups form-captcha"></div>      <p class="dialog-line">        <label for="loginRemember" class="checkbox-inline">          <input type="checkbox" name="remember" id="loginRemember" checked="checked" />          下次自动登录        </label>        <a style="margin-left:50px" class="forget-password" href="{{tuchongRoot()}}account/forget/" target="_blank">忘记密码</a>        <button style="margin-left:10px" class="btn btn-sm btn-primary" type="submit">登录</button>      </p>      <p class="connect">        <span>无需注册，用社交帐号登录：</span>        <a href="{{tuchongRoot()}}weibo/auth/" class="ir weibo-small">用微博登录</a>        <a href="{{tuchongRoot()}}weixin/auth/" class="ir weixin-small">用微信登录</a>        <a href="{{tuchongRoot()}}qq/auth/" class="ir qq-small">用QQ登录</a>      </p>    </div>  </form></div>'}),twig({id:"dialogs/multi-photo",data:'<div class="dialog dialog-multi-photo">  <h2>发布成功</h2>  <div class="dialog-body">  <p style="padding: 0 15px;">为了让您的作品得到更多曝光，图虫网可能在其他主流的第三方平台（微博，微信，今日头条等）推广您的作品。如果您因为特殊原因不想被推荐，可进入设置页设置修改。</p>  <p style="text-align: right;"><a class="multi-photo-btn" href="/settings/preferences/" target="_blank">去设置</a><a class="multi-photo-btn know-btn">知道了</a></p>  </div></div>'}),twig({id:"dialogs/new-message",data:'<div class="dialog" style="width:450px">  <form class="form-horizontal message-form" action="/rest/messages" method="post" onsubmit="$(this).ajaxsubmit(local.operation);return false;">    {{hiddenNonce()}}    <div class="dialog-body">      <div class="form-groups">        <label class="col-xs-2 control-label">发给:</label>        <div class="col-xs-10">          <input class="form-control" type="text" class="form-control" name="receiver" value="{{recipient}}"{% if not recipient %} autofocus{% endif %} />        </div>      </div>      <div class="form-groups">        <label class="col-xs-2 control-label">内容:</label>        <div class="col-xs-10">          <textarea name="content" class="form-control" {% if recipient %} autofocus{% endif %} title="Ctrl+Enter快捷提交" onkeyup="ctrlenterkey(this.form, event)"></textarea>        </div>      </div>    </div>    <p class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">发送</button>    </p>  </form></div>'}),twig({id:"dialogs/notify-event",data:'<div class="dialog">  <form action="/rest/activity/{{tag_id}}/notice" method="post" onsubmit="$(this).ajaxsubmit(local.showInDialog); return false;">    <h2>通知关注者</h2>    <input type="hidden" name="tag_id" value="{{tag_id}}" />    <div class="dialog-body">      <textarea name="content" placeholder="说点什么吧" class="form-control">{{message}}</textarea>    </div>    <div class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">群发通知</button>    </div>  </form></div>'}),twig({id:"dialogs/permalink",data:'<div class="dialog permalink-d">  <h2>    外链地址    <a class="x-delete" href="javascript:void(0)" onclick="dialog.close();">关闭</a>  </h2>  <div class="dialog-body">    <p>      大图({{image_f_size.width}}*{{image_f_size.height}})      <div class="row clearfix">        <div class="col-xs-10">          <input type="text" class="form-control" class="text" value="{{ image|imageUrl(\'f\') }}" onclick="$( this ).select()" onmouseover="$( this ).select()" />        </div>        <div class="col-xs-2">          <button onclick="copyToClipboard( $(this).prev().val() )" class="btn btn-primary btn-sm">复制</button>        </div>      </div>    </p>    <p>      中图({{image_l_size.width}}*{{image_l_size.height}})      <div class="row clearfix">        <div class="col-xs-10">          <input type="text" class="form-control" class="text" value="{{ image|imageUrl(\'l\') }}" onclick="$( this ).select()" onmouseover="$( this ).select()" />        </div>        <div class="col-xs-2">          <button onclick="copyToClipboard( $(this).prev().val() )" class="btn btn-primary btn-sm">复制</button>        </div>      </div>    </p>  </div>  <div class="dialog-footer">    <button class="btn btn-sm btn-primary" onclick="dialog.close();">关闭</button>  </div></div>'}),twig({id:"dialogs/post-content",data:'<div class="dialog" style="width: 680px;">    <h2>图博描述详情</h2>    <div class="dialog-body">    <p class="dialog-post-content" style="max-height: 400px;overflow: scroll;font-size: 16px;line-height: 2;">    {% autoescape false %}    {{parsedContent}}    {% endautoescape %}    </p>    </div>  </form></div>'}),twig({id:"dialogs/reject-reasons",data:'<div class="dialog" style="width:300px;">  <form action="/rest/requests/moderation" method="post">    <h2>      拒绝的理由      <a class="x-delete" href="javascript:void(0)" onclick="dialog.close();">关闭</a>    </h2>    <input type="hidden" name="request_id" value="{{request_id}}" />    <input type="hidden" name="status" value="reject" />    <div class="dialog-body">      <ul>        <li>          <label>            <input type="checkbox" name="reasons[]" value="本小组只加熟人" />            本小组只加熟人          </label>        </li>        <li>          <label>            <input type="checkbox" name="reasons[]" value="申请理由不够充分" />            申请理由不够充分          </label>        </li>        <li>          <label>            <input type="checkbox" name="reasons[]" value="你的作品和小组定位不符" />            你的作品和小组定位不符          </label>        </li>        <li>          自定义理由：          <br />          <textarea name="reasons[]" style="width:100%" autofocus></textarea>        </li>      </ul>    </div>    <div class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">拒绝</button>    </div>  </form></div>'}),twig({id:"dialogs/repost",data:'<div class="dialog dialog-repost">  <form action="/api/groups-post/create/" method="post" onsubmit="$(this).ajaxsubmit(local.showInDialog, local.alert);return false;">    <input type="hidden" name="post_id" value="{{post_id}}" />    <h2>转发</h2>    <div class="dialog-body">      {% if weiboAccount %}      <p style="margin:0.5em 0;">        <label class="checkbox-inline">          <input type="checkbox" name="postToWeibo" />          转发到新浪微博        </label>      </p>      {% endif %}      <div class="repost-to-site" style="display:none;">        <p style="margin:1em 0">转发到小组：</p>        <ul></ul>      </div>      {#<p class="center"><textarea autofocus name="content" style="width:400px;height:100px;" onkeyup="ctrlenterkey(this.form, event)" title="Ctrl+Enter快捷提交" placeholder="说点什么吧"></textarea></p>#}    </div>    <p class="dialog-footer">      <button type="reset" onclick="dialog.close()" class="btn btn-sm btn-default">取消</button>      <button type="submit" class="btn btn-sm btn-primary">确定</button>    </p>  </form></div>'}),twig({id:"dialogs/share-to-weixin",data:'<div class="dialog">    <h2>分享到微信</h2>    <div class="dialog-body">    <p style="text-align: center;margin: 10px;">打开微信，使用“扫一扫”，即可将网页分享至朋友圈</p>    <img src="/rest/qrcode?url={{url}}" style="width: 200px;margin: 0 auto;display: block;">    </div>  </form></div>'})});
